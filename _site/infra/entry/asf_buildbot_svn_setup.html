<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1"><!-- Begin Jekyll SEO tag v2.8.0 -->
<title>ASF Buildbot svn setup | Blogs Archive</title>
<meta name="generator" content="Jekyll v3.9.3" />
<meta property="og:title" content="ASF Buildbot svn setup" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Here at the ASF we have a subversion setup with all our projects code in one repository, with each of those projects having their own style of trunk/branches/tags/site etc.. This works well for us, but did present us with some initial problems when setting up our Buildbot instance to work with it." />
<meta property="og:description" content="Here at the ASF we have a subversion setup with all our projects code in one repository, with each of those projects having their own style of trunk/branches/tags/site etc.. This works well for us, but did present us with some initial problems when setting up our Buildbot instance to work with it." />
<link rel="canonical" href="http://localhost:4000/infra/entry/asf_buildbot_svn_setup" />
<meta property="og:url" content="http://localhost:4000/infra/entry/asf_buildbot_svn_setup" />
<meta property="og:site_name" content="Blogs Archive" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2010-03-29T10:25:59-04:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="ASF Buildbot svn setup" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2010-03-29T10:25:59-04:00","datePublished":"2010-03-29T10:25:59-04:00","description":"Here at the ASF we have a subversion setup with all our projects code in one repository, with each of those projects having their own style of trunk/branches/tags/site etc.. This works well for us, but did present us with some initial problems when setting up our Buildbot instance to work with it.","headline":"ASF Buildbot svn setup","mainEntityOfPage":{"@type":"WebPage","@id":"http://localhost:4000/infra/entry/asf_buildbot_svn_setup"},"url":"http://localhost:4000/infra/entry/asf_buildbot_svn_setup"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/assets/main.css"><link type="application/atom+xml" rel="alternate" href="http://localhost:4000/feed.xml" title="Blogs Archive" /></head>
<body><header class="site-header" role="banner">

  <div class="wrapper"><a class="site-title" rel="author" href="/">Blogs Archive</a><nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger"><a class="page-link" href="/about/">About</a></div>
      </nav></div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">ASF Buildbot svn setup</h1>
    <p class="post-meta">
      <time class="dt-published" datetime="2010-03-29T10:25:59-04:00" itemprop="datePublished">Mar 29, 2010
      </time>â€¢ <span itemprop="author" itemscope itemtype="http://schema.org/Person"><span class="p-author h-card" itemprop="name">{"display_name"=>"asf blog administrator", "login"=>"asfadmin", "email"=>"gmcdonald@apache.org"}</span></span></p>
  </header>

  <div class="post-content e-content" itemprop="articleBody">
    <p>Here at the ASF we have a subversion setup with all our projects code in one repository, with each of those projects having their own style of trunk/branches/tags/site etc.. This works well for us, but did present us with some initial problems when setting up our Buildbot instance to work with it.</p>
<p>Knowing that others have the same or similar arrangement with their svn instance, we thought we would share how we got Buildbot working well for us. Note that this is not a tutorial on Buildbot, more of a quick mini guide with more code than explanation, hoping you'll work out the rest for your needs.We will be working with four files:- svn_buildbot.py, post-commit, buildbot_project_paths and master.cfg.</p>
<p>First off, we needed to alter a section of the svn_buildbot.py file that comes in the buildbot/contrib directory. We copied this file to our svn host machine and edited this section:</p>
<pre>def split_file_branches(changed_file, project_paths):

    pieces = changed_file.split(os.sep)
    #Assume the layout is something like :
    # trunk => foo/bar/baz/trunk/file
    # branches/test  => foo/bar/baz/branches/test/file
    # Slurp everything up to one of these 2 'markers' and call that the branch
    found = False

    f = open(project_paths, 'r')
    for line in f.readlines():
        line = line.strip()
        regexp = re.compile(line)
        m = regexp.match(changed_file)
        if m:
            branch = m.group(1)
            path =   m.group(2)
            print >> sys.stderr, "branch=%s, path=%s" % (branch, path)
            return (branch, path)
  
    
    i = 0
    for piece in pieces:
        i = i + 1	
        # Find trunk, we are done
        if piece == 'trunk':
            found = True
            break
        elif piece == 'branches':
            i = i + 1
            found = True
            break
        
    # We found a layout we know, so send it to buildbot
    if found:
        branch = os.path.join(*pieces[0:i]) 
        path =   os.path.join(*pieces[i:])
    else:        
        branch = pieces[0]
        path = os.path.join(*pieces[1:])
            
    print >> sys.stderr, "branch=%s, path=%s" % (branch, path)
    return (branch, path)     
       
    #return (pieces[0], os.path.join(*pieces[1:]))

    raise RuntimeError("cannot determine branch for '%s'" % changed_file)

split_file = split_file_branches
</pre>
<p>Next up , the relevant entry in our subversion/hooks/post-commit file looks like this (with&nbsp;constants defined earlier in the file): </p>
<pre>    $SVNLOOK dirs-changed -r "$REV" "$REPOS" | egrep -qf "$BUILDBOT_PROJECT_PATHS" &amp;&amp; 
( $BUILDBOT --repository "$REPOS" --revision "$REV" --bbserver "$BBSERVER" --bbport "$BBPORT" 
--project-paths "$BUILDBOT_PROJECT_PATHS" >>/var/log/svn_buildbot.log 2>&amp;1 &amp; )
</pre>
<p>And, last but not least for the svn host side of things, our buildbot_project_paths file which contains entries such as :</p>
<pre>^(<strong>incubator/wookie/trunk</strong>)/(.*)
^(stdcxx/trunk)/(.*)
^(incubator/trafficserver/traffic/trunk)/(.*)
^(incubator/trafficserver/traffic/branches/2.0.x)/(.*)
^(subversion/trunk)/(.*)
</strong /></strong /></pre>
<p>So you create an entry from the svn base directory for each projects trunk or branch that you want Buildbot to take notice of, the rest being ignored.</p>
<p>Now, we match those buildbot_project_paths entries in our master.cfg file with an AnyBranchScheduler like this:</p>
<pre># schedulers
from buildbot.scheduler import AnyBranchScheduler

c['schedulers'].append(AnyBranchScheduler(name="on-wookie-commit",
                         branches=["<strong>incubator/wookie/trunk</strong>"],
                         treeStableTimer=2,
                         builderNames=["wookie-trunk"]))

#builders

f28 = factory.BuildFactory()
f28.addStep(SVN(
    mode="clobber",
    baseURL="http://svn.apache.org/repos/asf/",
    defaultBranch="<strong>incubator/wookie/trunk</strong>",
    haltOnFailure=True,
))

etc...
</pre>
<h4>Summary</h4>
<p>So, to tie it all together, what we have done is created a workflow like this:-</p>
<ol>
<li>A commit happens, the post-commit file checks the buildbot_project_paths file to see if it is relevant to any of our projects. If not, nothing else happens. </li>
<li>If we have a match then svn_buildbot.py is called, and uses the entry in buildbot_project_paths as the branch with the root dir of svn as the base, then sends these two pieces of information over to the Buildbot master. </li>
<li>The Buildbot master checks its config, finds a match in the 'branches' entry for our AnyBranchScheduler and triggers the appropriate build. </li>
</ol>
<p>I hope that helps someone out there , at least, until Buildbot project changes again, it is a fast moving project currently! - 0.80 for instance has introduced the 'project' property and the 'repository' property for schedulers which may negate the need for some of this, but I haven't investigated to date. (See&nbsp;<a href="http://github.com/djmitche/buildbot/blob/buildbot-0.8.0/NEWS">http://github.com/djmitche/buildbot/blob/buildbot-0.8.0/NEWS</a>&nbsp;for more info on that.)</p>

  </div><a class="u-url" href="/infra/entry/asf_buildbot_svn_setup" hidden></a>
</article>

      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/"></data>

  <div class="wrapper">

    <h2 class="footer-heading">Blogs Archive</h2>

    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <ul class="contact-list">
          <li class="p-name">Blogs Archive</li><li><a class="u-email" href="mailto:issues@infra.apache.org">issues@infra.apache.org</a></li></ul>
      </div>

      <div class="footer-col footer-col-2"><ul class="social-media-list"><li><a href="https://github.com/jekyll"><svg class="svg-icon"><use xlink:href="/assets/minima-social-icons.svg#github"></use></svg> <span class="username">jekyll</span></a></li><li><a href="https://www.twitter.com/jekyllrb"><svg class="svg-icon"><use xlink:href="/assets/minima-social-icons.svg#twitter"></use></svg> <span class="username">jekyllrb</span></a></li></ul>
</div>

      <div class="footer-col footer-col-3">
        <p>This is an archive of the Roller blogs that were previously hosted on blogs.apache.org</p>
      </div>
    </div>

  </div>

</footer>
</body>

</html>
