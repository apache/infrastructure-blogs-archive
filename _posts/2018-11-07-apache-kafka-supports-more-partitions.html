---
layout: post
status: PUBLISHED
published: true
title: Apache Kafka Supports 200K Partitions Per Cluster
author:
  display_name: Jun Rao
  login: junrao
  email: junrao@gmail.com
author_login: junrao
author_email: junrao@gmail.com
id: 399ccb29-15f1-4577-b8c9-61969a23ce14
date: '2018-11-07 01:10:00 -0500'
categories:
- Technology
tags: []
comments:
- id: 0
  author: webdevelopmentcompany
  author_email: jasonstar9797@gmail.com
  author_url: https://route66designinc.com.au/service/website-design/
  date: '2018-12-28 17:32:10 -0500'
  content: very informative blog i really like your website it your posts blogs are
    technical and helpful.
- id: 0
  author: Manvir Gurdee
  author_email: mgurapwe1@aol.com
  author_url: ''
  date: '2019-12-25 13:02:01 -0500'
  content: "At its heart lies the humble, immutable commit log, and from there you
    can subscribe to it, and publish data to any number of systems or real-time applications.
    Unlike messaging queues, Kafka is a highly scalable, fault tolerant distributed
    system, allowing it to be deployed for applications like managing passenger and
    driver matching at Uber, providing real-time analytics and predictive maintenance
    for British Gas&rsquo; smart home, and performing numerous real-time services
    across all of LinkedIn. This unique performance makes it perfect to scale from
    one app to company-wide use. https://www.manchestertaxicompany.co.uk/\r\n\r\n"
- id: 0
  author: sbobet
  author_email: tunasbolaid@gmail.com
  author_url: http://37.60.246.153/login/
  date: '2020-02-08 04:51:24 -0500'
  content: "Apache Kafka trends on Google nice good mantap\r\n\r\nhttp://37.60.246.153/login/\r\nhttp://146.66.105.92/\r\nhttp://109.73.234.191/\r\nhttps://tunasbola.org/link-alternatif-sbobet/\r\nhttp://146.66.105.215/"
- id: 0
  author: film izle
  author_email: dadadada@gmail.com
  author_url: https://altyazilifilm.live
  date: '2019-06-29 20:44:15 -0400'
  content: "Figure 1. (1) shutdown initiated on broker 1; (2) broker 1 sends controlled
    shutdown request to controller on broker 0; (3) controller writes new leaders
    in ZooKeeper; (4) controller sends new leaders to broker 2; (5) controller sends
    successful reply to broker 1.\r\n"
- id: 0
  author: nayra
  author_email: freecalendarkart@gmail.com
  author_url: http://freecalendarkart.com/
  date: '2019-07-11 15:27:21 -0400'
  content: very informative tool
- id: 0
  author: MPL
  author_email: eenadu@gmail.com
  author_url: https://www.undoshiftdelete.com/mpl-download-for-pc/
  date: '2019-08-02 18:41:30 -0400'
  content: Thanks for the great post. Really informative for using the Kafka brokers
    in the list.
- id: 0
  author: Earl Bennett
  author_email: earlbennett1798@gmail.com
  author_url: ''
  date: '2019-08-27 07:38:44 -0400'
  content: Kafka already made a very significant improvement in terms of number of
    partitions a single Kafka can support. https://www.watersoftenergurus.com/fleck-water-softener/
- id: 0
  author: Roy
  author_email: royrussell7921@gmail.com
  author_url: ''
  date: '2019-09-03 09:55:56 -0400'
  content: There is a very significant difference in the controlled shutdown time
    that's why it operates faster. https://www.assistedonlinefilings.com/
- id: 0
  author: Juan
  author_email: lafavellc@gmail.com
  author_url: ''
  date: '2019-11-09 23:23:35 -0500'
  content: 'https://www.sanjosejunkremoval.net/ Thank you for the write up. We use
    same thing. '
- id: 0
  author: Michael
  author_email: lafavellc@gmail.com
  author_url: ''
  date: '2019-11-11 17:31:43 -0500'
  content: I like the way these tests were executed https://www.onlinemarketingshark.com/
- id: 0
  author: Dead Pool
  author_email: santarosacleaner@gmail.com
  author_url: https://www.santarosapool.com/
  date: '2019-12-12 05:40:58 -0500'
  content: "I'd have gone with Metamorphosis but it was probably taken.\r\n\r\nhttps://www.santarosacleaningservice.com/"
- id: 0
  author: 5dog digital
  author_email: jon@5dogdigital.com
  author_url: https://www.5dogdigital.com/
  date: '2019-12-12 05:47:26 -0500'
  content: "\"One morning, when Gregor Samsa woke from troubled dreams, he found himself
    transformed in his bed into a horrible vermin. \" hands down in the top 10 opening
    lines in Literature. haha!\r\nhttps://www.5dogdigital.com/"
- id: 0
  author: surveymonkeyusa
  author_email: surveymonkeyusa166@gmail.com
  author_url: https://www.surveymonkeyusa.com/
  date: '2020-02-19 12:25:06 -0500'
  content: Great article Lot's of information to Read.Great Man Keep Posting and update
    to People.Thanks
- id: 0
  author: https://krogerfeeedback.us/
  author_email: danielwilsonn16@gmail.com
  author_url: https://krogerfeeedback.us/
  date: '2020-02-19 20:09:53 -0500'
  content: "Thank you for taking the time to  this information very useful! \r\n"
- id: 1
  author: https://online-application.org/social-security-administration-office/oklahoma/
  author_email: brianmorgan3846@gmail.com
  author_url: https://online-application.org/social-security-administration-office/oklahoma/
  date: '2019-08-02 01:58:03 -0400'
  content: Apache Kafka has improved tremendously in the number of partitions a single
    Kafka cluster and can support while preserving high availability and durability.
- id: 5
  author: Norris Notary
  author_email: nnoa12@aol.com
  author_url: https://www.notarypubliclondon-mmk.co.uk/
  date: '2019-12-25 13:02:58 -0500'
  content: "If you're unfamiliar with Kafka, it's a scalable, fault-tolerant, publish-subscribe
    messaging system that enables you to build distributed applications and powers
    web-scale Internet companies such as LinkedIn, Twitter, AirBnB, and many others.
    Small-scale open-source projects come and go, but it seems Kafka has some really
    strong momentum behind it. \r\n\r\n"
- id: 5
  author: Apps
  author_email: appspc@gmail.com
  author_url: https://appsforwindowspc.com/
  date: '2019-08-02 18:42:16 -0400'
  content: "Figure 1. (1) shutdown initiated on broker 1; (2) broker 1 sends controlled
    shutdown request to controller on broker 0; (3) controller writes new leaders
    in ZooKeeper; (4) controller sends new leaders to broker 2; (5) controller sends
    successful reply to broker 1.\r\n"
- id: 6
  author: Greg
  author_email: lafavellc@gmail.com
  author_url: ''
  date: '2019-11-12 20:47:38 -0500'
  content: I appreciate for allowing to comment on this subject. http://www.lawncareportorange.com/
- id: 6
  author: Steve Mendalson
  author_email: smarthouseunitedkingdom@gmail.com
  author_url: ''
  date: '2019-11-26 00:12:17 -0500'
  content: Apache Kafka's popularity is exploding. How can I learn more about it?
    https://www.smarthouselondon.co.uk/smart-lock.html
- id: 7
  author: Abogados de accidentes
  author_email: ashah12@aol.com
  author_url: https://www.abogadosdeaccidentesflorida.com/
  date: '2019-12-25 13:03:35 -0500'
  content: "RedMonk points out that Apache Kafka-related questions on StackOverflow,
    Apache Kafka trends on Google, and Kafka GitHub stars are all shooting up. In
    the graph below, you can see that GitHub interest has grown exponentially:\r\n\r\n"
- id: 8
  author: James
  author_email: budapestrealtors@gmail.com
  author_url: ''
  date: '2019-11-26 00:09:12 -0500'
  content: "I thought that since Kafka was a system optimized for writing using a
    writer&rsquo;s name would make sense. I had taken a lot\r\nof lit classes in colleague
    and liked Franz Kafka. Plus the name sounded cool for an OS project. James from
    https://www.realestateinbudapest.com"
- id: 8
  author: Jeff Yang
  author_email: highfei2011@126.com
  author_url: ''
  date: '2019-11-29 06:00:25 -0500'
  content: "请问一下怎样计算 Kafka 集群最大支持的 partition 数量呢？谢谢\r\n\r\n目前我们有一个 kafka 集群（5台，内存128MB，cpu
    16 core），\r\n当partition number （每个 topic 有 2个或者3个分区，每条 messege 大约 500KB）达到 36000
    个以后，占用的 virt memory 达到 370GB，这不正常。请问有解决的方法吗？扩容？谢谢"
- id: 9
  author: Gordon Windows
  author_email: goas12@aol.com
  author_url: https://www.glazingwindowsglasgow.co.uk/
  date: '2019-12-25 12:57:43 -0500'
  content: "Apache Kafka is a community distributed event streaming platform capable
    of handling trillions of events a day. Initially conceived as a messaging queue,
    Kafka is based on an abstraction of a distributed commit log. Since being created
    and open sourced by LinkedIn in 2011, Kafka has quickly evolved from messaging
    queue to a full-fledged event streaming platform.\r\n\r\n"
- id: 66
  author: protection de la peau
  author_email: wavilcecyg1987@gmail.com
  author_url: https://atopy-pharmacy.com/skin-care_fr.html
  date: '2019-07-20 16:29:50 -0400'
  content: reat neat! nice work wow, so quirky design. Love the colour, and compositions.
- id: 71
  author: apk advice
  author_email: sobuj033@gmail.com
  author_url: https://apkadvice.com/
  date: '2019-12-28 17:37:02 -0500'
  content: thanks to its very helpful aritcle
- id: 191
  author: Karoline
  author_email: chladek13@gmail.com
  author_url: ''
  date: '2019-12-29 23:53:37 -0500'
  content: Very good article http://hacknow2020.com
- id: 329
  author: Brian
  author_email: lafavellc@gmail.com
  author_url: ''
  date: '2019-11-10 20:05:34 -0500'
  content: "Figure 1. (1) shutdown initiated on broker 1; (2) broker 1 sends controlled
    shutdown request to the controller on broker 0; (3) controller writes new leaders
    in ZooKeeper; (4) controller sends new leaders to broker 2; (5) controller sends
    a successful reply to broker 1.? \r\nhttps://www.bcslocksmiths.com/"
- id: 845
  author: Horea Kaii
  author_email: horeakaii@gmail.com
  author_url: ''
  date: '2019-08-20 14:20:40 -0400'
  content: "I also agree with this one and this is the best thing to do actually.\r\nhttps://www.teetherpop.com/"
- id: 985
  author: Simon Ellis
  author_email: lafavellc@gmail.com
  author_url: ''
  date: '2019-11-19 18:05:45 -0500'
  content: I like the split of the partitions.  That explains a lot. How does the
    broker shut down when requested? https://www.glendaleconcretesolutions.com/
- id: 2601
  author: James
  author_email: lafavellc@gmail.com
  author_url: https://www.lafavellc.com/
  date: '2019-11-06 18:34:04 -0500'
  content: Thank you for the write-up. <a href="https://www.lafavellc.com/">https://www.lafavellc.com/</a>
- id: 7217
  author: ryan
  author_email: lafavellc@gmail.com
  author_url: https://www.lafavellc.com/
  date: '2019-11-06 18:29:21 -0500'
  content: 'This is going to be epic for helping me out. Appreciate the write up. '
- id: 7859
  author: Stephen Skips
  author_email: shaklwe1@aol.com
  author_url: ''
  date: '2019-12-25 13:00:38 -0500'
  content: "Founded by the original developers of Apache Kafka, Confluent delivers
    the most complete distribution of Kafka with Confluent Platform. Confluent Platform
    improves Kafka with additional community and commercial features designed to enhance
    the streaming experience of both operators and developers in production, at massive
    scale.\r\nhttps://www.skiphiresglasgow.co.uk\r\n"
- id: 8500
  author: howard
  author_email: santarosadrywall@gmail.com
  author_url: https://www.santarosadrywall.com/
  date: '2019-12-12 05:35:33 -0500'
  content: "Good call Kafka is the man, too bad nobody published him until after he
    passed.\r\nhttps://www.mysantarosalandscaping.com/\r\n"
- id: 63345
  author: Apksnake
  author_email: dave.hager.dave@gmail.com
  author_url: http://apksnake.com/
  date: '2019-08-08 20:41:50 -0400'
  content: With this post you just saved me, the whole point is that I am currently
    working on my project http://apksnake.com/ and it was precisely this information
    that I did not have, thanks for the help!
- id: 83330
  author: 'Shubham '
  author_email: allrealfacts2@gmail.com
  author_url: https://allrealfacts.com/
  date: '2019-12-04 06:15:54 -0500'
  content: I thought that since Kafka was a system optimized for writing using a writer&rsquo;s
    name would make sense. I had taken a lot of lit classes in colleague and liked
    Franz Kafka. Plus the name sounded cool for an OS project.
- id: 88553
  author: Earnest
  author_email: lafavellc@gmail.com
  author_url: ''
  date: '2019-11-15 17:04:37 -0500'
  content: "Excellent explanation!!\r\nhttps://www.topazcleaning.com/"
- id: 205488
  author: Jeo
  author_email: hvackenosha@gmail.com
  author_url: ''
  date: '2019-11-06 18:40:28 -0500'
  content: "https://www.hvackenosha.com/\r\nhttps://www.gallerycompany.com/\r\nhttps://www.fulldrawconstruction.com\r\nhttps://www.bfjfloorcare.com/\r\nhttps://www.sanjosejunkremoval.net/\r\nhttps://www.junkcarsmilwaukee.com/\r\nhttps://www.kenoshatowingservice.com/\r\nhttps://www.racinetowing.com/\r\nhttps://www.sanfranciscotowingservices.com/\r\nhttp://higherpowerpressurewash.com/\r\nhttps://www.brewcitycarpetcleaning.com/\r\n\r\n\r\n\r\n\r\n\r\n"
- id: 721409
  author: Cider
  author_email: hareeshyupp@gmail.com
  author_url: https://www.undoshiftdelete.com/cider-apk/
  date: '2019-08-02 12:03:09 -0400'
  content: 'Really impressive. We have used Kafka for functionalities like Continue
    Watching data processing from players. I think we can get a lot more other things
    to do with Apache kafka. '
- id: 4916243
  author: Jay S
  author_email: treeleedsuk@gmail.com
  author_url: ''
  date: '2019-11-26 00:14:14 -0500'
  content: "What are the most important things you learned from building Apache Kafka?
    \r\n\r\nhttps://www.treeleeds.co.uk"
- id: 8170747
  author: Brielle Luna
  author_email: brielleluna@hotmail.com
  author_url: ''
  date: '2019-08-14 15:49:12 -0400'
  content: Kafka is used for building real-time data pipelines and streaming apps.
    It is horizontally scalable, fault-tolerant, wicked fast, and runs in production
    in thousands of companies, and with that, (https://www.junkyarddogonline.com/)
    wants to learn and have it!
- id: 18577148
  author: Shelly
  author_email: lafavellc@gmail.com
  author_url: ''
  date: '2019-11-13 22:11:00 -0500'
  content: I think this is an insanely power dialogue. Thank you for sharing.  http://www.mysmartinspection.com/
- id: 47972686
  author: Erica
  author_email: gallerycitations@gmail.com
  author_url: ''
  date: '2019-11-10 20:01:10 -0500'
  content: "I couldn't agree more. Very good explanation. \r\nhttps://www.gallerycompany.com/"
permalink: kafka/entry/apache-kafka-supports-more-partitions
---
<p>In Kafka, a topic can have multiple partitions to which records are distributed. Partitions are the unit of parallelism. In general, more partitions leads to higher throughput. However, there are some factors that one should consider when having more partitions in a Kafka cluster. I am happy to report that the recent Apache Kafka 1.1.0 release has significantly increased the number of partitions that a single Kafka cluster can support from the deployment and the availability perspective.<br />
</P></p>
<p>
To understand the improvement, it&rsquo;s useful to first revisit some of the basics about partition leaders and the controller. First, each partition can have multiple replicas for higher availability and durability. One of the replicas is designated as the leader and all the client requests are served from this lead replica. Second, one of the brokers in the cluster acts as the controller that manages the whole cluster. If a broker fails, the controller is responsible for selecting new leaders for partitions on the failed broker.</p>
<p>
The Kafka broker does a controlled shutdown by default to minimize service disruption to clients. A controlled shutdown has the following steps. (1) A SIG_TERM signal is sent to the broker to be shut down. (2) The broker sends a request to the controller to indicate that it&rsquo;s about to shut down. (3) The controller then changes the partition leaders on this broker to other brokers and persists that information in ZooKeeper. (4) The controller sends the new leader to other brokers. (5) The controller sends a successful reply to the shutting down broker, which finally terminates its process. At this point, there is no impact to the clients since their traffic has already been moved to other brokers. This process is depicted in Figure 1 below. Note that step (4) and (5) can happen in parallel.</p>
<p><img src="https://blogs.apache.org/kafka/mediaresource/6d48ae3f-e91c-41e1-bc97-26a786a54b48" width="704" height="220"><br />
<br><b>Figure 1.</b> (1) shutdown initiated on broker 1; (2) broker 1 sends controlled shutdown request to controller on broker 0; (3) controller writes new leaders in ZooKeeper; (4) controller sends new leaders to broker 2; (5) controller sends successful reply to broker 1.</p>
<p>
Before Kafka 1.1.0, during the controlled shutdown, the controller moves the leaders one partition at a time. For each partition, the controller selects a new leader,  writes it to ZooKeeper synchronously and communicates the new leader to other brokers through a remote request. This process has a couple of inefficiencies. First, the synchronous writes to ZooKeeper have higher latency, which slows down the controlled shutdown process. Second, communicating the new leader one partition at a time adds many small remote requests to every broker, which can cause the processing of the new leaders to be delayed.</p>
<p>
In Kafka 1.1.0, we made significant improvements in the controller to speed up the controlled shutdown. The first improvement is using the asynchronous API when writing to ZooKeeper. Instead of writing the leader for one partition, waiting for it to complete and then writing another one, the controller submits the leader for multiple partitions to ZooKeeper asynchronously and then waits for them to complete at the end. This allows for request pipelining between the Kafka broker and the ZooKeeper server and reduces the overall latency. The second improvement is that the communication of the new leaders is batched. Instead of one remote request per partition, the controller sends a single remote request with the leader from all affected partitions.</p>
<p>
We also made significant improvement in the controller failover time. If the controller goes down, the Kafka cluster automatically elects another broker as the new controller. Before being able to elect the partition leaders, the newly-elected controller has to first reload the state of all partitions in the cluster from ZooKeeper. If the controller has a hard failure, the window in which a partition is unavailable can be as long as the ZooKeeper session expiration time plus the controller state reloading time. So reducing the state reloading time improves the availability in this rare event. Prior to Kafka 1.1.0, the reloading uses the synchronous ZooKeeper API. In Kafka 1.1.0, this is changed to also use the asynchronous API for better latency.</p>
<p>
We executed tests to evaluate the performance improvement of the controlled shutdown time and the controller reloading time. For both tests, we set up a 5 node ZooKeeper ensemble on different server racks.</p>
<p>
In the first test, we set up a Kafka cluster with 5 brokers on different racks. In that cluster, we created 25,000 topics, each with a single partition and 2 replicas, for a total of 50,000 partitions. So, each broker has 10,000 partitions. We then measured the time to do a controlled shutdown of a broker. The results are shown in the table below.</p>
<table  border="1">
<tr>
<th></th>
<th> kafka 1.0.0 </th>
<th> kafka 1.1.0 </th>
</tr>
<tr>
<th> controlled shutdown time </th>
<th> 6.5 minutes </th>
<th> 3 seconds </th>
</tr>
</table>
<p>
A big part of the improvement comes from fixing a logging overhead, which unnecessarily logs all partitions in the cluster every time the leader of a single partition changes. By just fixing the logging overhead, the controlled shutdown time was reduced from 6.5 minutes to 30 seconds. The asynchronous ZooKeeper API change reduced this time further to 3 seconds. These improvements significantly reduce the time to restart a Kafka cluster.</p>
<p>
In the second test, we set up another Kafka cluster with 5 brokers and created 2,000 topics, each with 50 partitions and 1 replica. This makes a total of 100,000 partitions in the whole cluster. We then measured the state reloading time of the controller and observed a 100% improvement (the reloading time dropped from 28 seconds in Kafka 1.0.0 to 14 seconds in Kafka 1.1.0).</p>
<p>
With those improvements, how many partitions can one expect to support in Kafka? The exact number depends on factors such as the tolerable unavailability window, ZooKeeper latency, broker storage type, etc. As a rule of thumb, we recommend each broker to have up to 4,000 partitions and each cluster to have up to 200,000 partitions. The main reason for the latter cluster-wide limit is to accommodate for the rare event of a hard failure of the controller as we explained earlier. Note that other considerations related to partitions still apply and one may need some additional configuration tuning with more partitions.</p>
<p>
The improvement that we made in 1.1.0 is just one step towards our ultimate goal of making Kafka infinitely scalable. We have also made improvements on latency with more partitions in 1.1.0 and will discuss that in a separate blog. In the near future, we plan to make further improvements to support millions of partitions in a Kafka cluster.</p>
<p>
The controller improvement work in Kafka 1.1.0 is a true community effort. Over a period of 9 months, people from 6 different organizations helped out and made this happen. Onur Karaman led the original design, did the core implementation and conducted the performance evaluation. Manikumar Reddy, Prasanna Gautam, Ismael Juma, Mickael Maison, Sandor Murakozi, Rajini Sivaram and Ted Yu each contributed some additional implementation or bug fixes. More details can be found in <a href="https://issues.apache.org/jira/browse/KAFKA-5642">KAFKA-5642</a> and <a href="https://issues.apache.org/jira/browse/KAFKA-5027">KAFKA-5027</a>. A big thank you to all the contributors!</p>
