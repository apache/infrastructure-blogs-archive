---
layout: post
status: PUBLISHED
published: true
title: 'Investing In Big Data: Apache HBase'
author:
  display_name: Andrew Purtell
  login: apurtell
  email: apurtell@apache.org
author_login: apurtell
author_email: apurtell@apache.org
id: 2bc56023-6000-41fe-81a0-55fce2437252
date: '2016-04-13 00:35:02 -0400'
categories:
- General
tags: []
comments: []
permalink: hbase/entry/investing_in_big_data_apache
---
<p style="text-align: justify;">This is the fourth in a series of posts on "Why We Use Apache HBase", in which we let HBase users and developers borrow our blog so they can showcase their successful HBase use cases, talk about why they use HBase, and discuss what worked and what didn't.</p>
<p style="text-align: justify;">Lars Hofhansl and Andrew Purtell are HBase Committers and PMC members. At Salesforce.com, Lars is a Vice President and Software Engineering Principal Architect, and Andrew is a Cloud Storage Architect.</p>
<p style="text-align: justify;">An earlier version of the discussion in this post was published <a href="https://medium.com/salesforce-open-source/investing-in-big-data-apache-hbase-b9d98661a66b">here</a> on the Salesforce + Open Source = ❤ blog.</p></p>
<blockquote>
<p>- Andrew Purtell</p>
</blockquote>
<hr />
<h2 style="text-align: left;">Investing In Big Data: Apache HBase</h2></p>
<p style="text-align: center;"> <img src="https://blogs.apache.org/hbase/mediaresource/01c39d56-6f9a-45ac-8542-303e2a7612c4" /></p>
<p style="text-align: center;"><em>&nbsp;By &copy; Earth at Night / CC BY 3.0</em></p>
<p style="text-align: justify;">The world is good at making data. You can see it in every corner of commerce and industry: everything we interact with is getting smarter, and producing a massive stream of readings, geolocations, images, and more. From medical devices to jet engines, it&rsquo;s transforming every part of the modern world. And it&rsquo;s accelerating!</p>
<p style="text-align: justify;">Salesforce&rsquo;s products are all about helping our customers connect with <em>their</em> customers. So obviously, a big part of that is equipping them to interact with all of the data a customer&rsquo;s interactions might generate, in whatever quantities it shows up in. We do that in many ways, across all of our products.&nbsp;</p>
<p style="text-align: justify;">In this post, we&rsquo;d like to zoom in on one particular Open Source data system we use and contribute heavily to: <a href="https://hbase.apache.org">Apache HBase</a>. If you&rsquo;re not familiar with HBase, this post will start with a few high level concepts about the system, and then go into how it fits in at Salesforce.&nbsp;</p></p>
<p style="text-align: center;"> <img src="https://blogs.apache.org/hbase/mediaresource/dddd92e2-1f97-49f6-aaae-ace7e736dd39" /></p>
<h3>What IS HBase?&nbsp;</h3>
<p style="text-align: justify;">HBase is an open source distributed database. It&rsquo;s designed to store record-oriented data across a scalable cluster of machines. We sometimes refer to it as a &ldquo;sparse, consistent, distributed, multi-dimensional, persistent, sorted map&rdquo;. This usually makes people say &ldquo;Wat??&rdquo;. So, to break that down a little bit:</p></p>
<ul>
<li style="text-align: justify;">distributed :  rows are spread over many machines;</li>
<li style="text-align: justify;">consistent :  it&rsquo;s strongly consistent (at a per-row level);</li>
<li style="text-align: justify;">persistent :  it stores data on disk with a log, so it sticks around;</li>
<li style="text-align: justify;">sorted : rows are stored in sorted order, making seeks very fast;</li>
<li style="text-align: justify;">sparse :  if a row has no value in a column, it doesn&rsquo;t use any space;</li>
<li style="text-align: justify;">multi-dimensional :  data is addressable in several dimensions: tables, rows, columns, versions, etc.</li>
</ul>
<p style="text-align: justify;">Think of it as a giant list of key / value pairs, spread over a large cluster, sorted for easy access.</p>
<p style="text-align: justify;">People often refer to HBase as a &ldquo;NoSQL&rdquo; store&ndash;a term coined back in 2009 to refer to a big cohort of similar systems that were doing data storage without SQL (Structured Query Language). Contributors to the HBase project will tell you they have always disliked that term, though; a toaster is also NoSQL. It&rsquo;s better to say HBase is architected differently than a typical relational database engine, and can scale out better for some use cases.</p>
<p style="text-align: justify;">Google was among the first companies to move in this direction, because they were operating at the scale of the entire web. So, they long ago built their infrastructure on top of a new kind of system (BigTable, which is the direct intellectual ancestor of HBase). It grew from there, with dozens of Open Source variants on the theme emerging in the space of a few years: Cassandra, MongoDB, Riak, Redis, CouchDB, etc.&nbsp;</p>
<h3>Why use a NoSQL store, if you already have a relational database?</h3>
<p style="text-align: justify;">Let&rsquo;s be clear: relational databases are terrific. They&rsquo;ve been the dominant form of data storage on Earth for nearly three decades, and that&rsquo;s not by accident. In particular, they give you one really killer feature: the ability to decompose the physical storage of data into different conceptual buckets (entities, aka tables), with relationships to each other &hellip; and to <em>modify</em> the state of many related values atomically (transactions). This incurs a cost (for finding and re-assembling the decomposed data when you want to read it) but relational database query planners have gotten so shockingly good that this is actually a perfectly good trade-off in most cases.</p>
<p style="text-align: justify;">Salesforce is <em>deeply</em> dependent on relational databases. A majority of our row-oriented data still lives there, and they are integral to the basic functionality of the system. We&rsquo;ve been able to scale them to massive load, both via our unique data storage architecture, and also by sharding our entire infrastructure (more on that in the <a href="https://medium.com/salesforce-engineering/the-architecture-files-ep-2-the-crystal-shard-a6025bd9f968">The Crystal Shard</a>, a post by Ian Varley&nbsp;on the Salesforce blog). They&rsquo;re not going anywhere. On the contrary, we do constant and active research into new designs for scaling and running relational databases.&nbsp;</p>
<p style="text-align: justify;">But, it turns out there are a subset of use cases that have <em>very</em> different requirements from relational data. In particular, less emphasis on webs of relationships that require complex transactions for correctness, and more emphasis on large streams of data that accrue over time, and need linear access characteristics. You certainly <em>can</em> store these in an RDBMS. But, when you do, you&rsquo;re essentially paying a penalty (performance and scale limitations) for features you don&rsquo;t need; a simpler design can scale more powerfully.</p>
<p>It&rsquo;s for those new use cases&ndash;and all the customer value they unlock&ndash;that we&rsquo;ve added HBase to our toolkit.</p>
<h3>Of all the NoSQL stores, why HBase?</h3>
<p style="text-align: justify;">This question comes up a lot: people say, &ldquo;I heard XYZ-database is web scale, you should use that!&rdquo;. The world of &ldquo;polyglot persistence&rdquo; has produced a boatload of choices, and they all have their merits. In fact, we use almost all of them <em>somewhere</em> in the Salesforce product suite: Cassandra, Redis, CouchDB, MongoDB, etc.</p>
<p style="text-align: justify;">To choose HBase as a key area of investment for Salesforce Core, we went through a pretty intense &ldquo;bake-off&rdquo; process that included evaluations of several different systems, with experiments, spikes, POCs, etc. The decision ultimately came down to three big points for us: </p></p>
<ol>
<li style="text-align: justify;">HBase is a <strong>strongly consistent</strong> store. In the <a href="http://en.wikipedia.org/wiki/CAP_theorem">CAP Theorem</a>, that means it&rsquo;s a (CP) store, not an (AP) store. Eventual consistency is great when used for the right purpose, but it can tend to push challenges up to the application developer. We didn&rsquo;t think we&rsquo;d be able to absorb that extra complexity, for general use in a product with such a large surface area.&nbsp;
</li>
<li style="text-align: justify;">It&rsquo;s a <strong>high quality </strong>project. It did well in our benchmarks and tests, and is well respected in the community. Facebook built their entire Messaging infrastructure on HBase (as well as many other things), and the Open Source community is active and friendly.
</li>
<li style="text-align: justify;">The <strong>Hadoop ecosystem</strong> already had an operational presence at Salesforce. We&rsquo;ve been using Hadoop in the product for ages, and we already had a pretty good handle on how to deploy and operate it. HBase can use Hadoop&rsquo;s distributed filesystem for persistence and offers first class integration with MapReduce (and, coming soon, Spark), so is a way to level up existing Hadoop deployments with modest incremental effort.</li>
</ol>
<div style="text-align: justify;">
<div>
<p>Our experience was (and still is) that HBase wasn&rsquo;t the easiest to get started with, but it was the most dependable at scale; we sometimes refer to it as the &ldquo;<em>industrial strength</em>&rdquo; scalable store, ready for use in demanding enterprise situations, and taking issues like data durability and security extremely seriously.&nbsp;</p>
</p></div>
<div>
<p>HBase (and its API) is also broadly used in the industry. HBase is an option on Amazon&rsquo;s EMR, and is also available as part of Microsoft&rsquo;s Azure offerings. Google Cloud includes a hosted BigTable service sporting the de-facto industry standard HBase client API. (It&rsquo;s fair to say the HBase client API has widespread if not universal adoption for Hadoop and Cloud storage options, and will likely live on beyond the HBase engine proper.)&nbsp;</p>
</p></div>
<h3>When does Salesforce use HBase?</h3>
<p>There are three indicators we look at when deciding to run some functionality on HBase. We want things that are <strong>big</strong>, <strong>record-oriented</strong>, and <strong>transactionally independent</strong>.&nbsp;</p>
<p>By &ldquo;big&rdquo;, we mean things in the ballpark of hundreds of millions of rows <em>per tenant</em>, or more. HBase clusters in the wild have been known to grow to thousands of compute nodes, and hundreds of Petabytes, which is substantially bigger than we&rsquo;d ever grow a single one of our instance relational databases to. (None of our individual clusters are that big yet, mind you.) Data size is not only not a challenge for HBase, it&rsquo;s a desired <em>feature</em>!</p>
<p>By &ldquo;record-oriented&rdquo;, we mean that it &ldquo;looks like&rdquo; a database, not a file store. If your data can be modeled as big <a href="http://en.wikipedia.org/wiki/Binary_large_object">BLOBs</a>, and you don&rsquo;t need to independently read or write small bits of data in the middle of those big blobs, then you should use a file store.</p>
<p>Why does it matter if things are record-oriented? After all, HBase is built on top of <a href="http://hadoop.apache.org/docs/r2.7.2/hadoop-project-dist/hadoop-hdfs/HdfsDesign.html">HDFS</a>, which is &hellip; a file store. The difference is that the essential function that HBase plays is specifically to let you treat big immutable files as if they were a mutable database. To do this magic, it uses something called a <a href="http://en.wikipedia.org/wiki/Log-structured_merge-tree">Log Structured Merge Tree</a>, which provides for both fast reads and fast writes. (If that seems impossible, read up on LSMs; they&rsquo;re legitimately impressive.)</p>
<p>And, what do we mean by &ldquo;transactionally independent&rdquo;? Above, we described that a key feature of relational databases is their <i>transactional consistency</i>: you can modify records in many different tables and have those modifications either commit or rollback as a unit. HBase, as a separate data store, doesn&rsquo;t participate in these transactions, so for any data that spans both stores, it requires application developers to reason about consistency on their own. This is doable, but it is tricky. So, we prefer to emphasize those cases where that reasoning is simple <i>by design</i>.&nbsp;</p>
</p></div>
<p style="text-align: justify;">(For the hair-splitters out there, note that HBase does offer consistent &ldquo;transactions&rdquo;, but only on a single-row basis, not across different rows, objects, or (most importantly) different databases.)</p>
<p style="text-align: justify;">One criterion for using HBase that you&rsquo;ll notice we <i>didn&rsquo;t</i> mention is that as a &ldquo;NoSQL&rdquo; store, you wouldn&rsquo;t use it for something that called for using SQL. <b>The reason we didn&rsquo;t mention that is that <i>it isn&rsquo;t true</i>!</b> We built and open sourced a library called &ldquo;Phoenix&rdquo; (which later became <a href="http://phoenix.apache.org/">Apache Phoenix</a>) which brings a SQL access layer to HBase. So, as they say, &ldquo;We put the SQL back in NoSQL&rdquo;. </p>
<p style="text-align: justify;">We treat HBase as a &ldquo;System Of Record&rdquo;, which means that we depend on it to be every bit as secure, durable and available as our other data stores. Getting it there required a lot of work: accounting for site switching, data movement, authenticated access between subsystems, and more. But we&rsquo;re glad we did!</p>
<h3>What features does Salesforce use HBase for? </h3>
<p style="text-align: justify;">To give you a concrete sense of some of what HBase is used for at Salesforce, we&rsquo;ll mention a couple of use cases briefly. We&rsquo;ll also talk about more in future posts.</p>
<p style="text-align: justify;">The main place you may have seen HBase in action in Salesforce to date is what we call <a href="https://www.salesforce.com/blog/2015/07/introducing-salesforce-shield.html">Salesforce Shield</a>. Shield is a connected suite of product features that enable enterprise businesses to encrypt data and track user actions. This is a requirement in certain protected sectors of business, like Health and Government, where compliance laws dictate the level of retention and oversight of access to data. </p>
<p style="text-align: justify;">One dimension of this feature is called <a href="https://developer.salesforce.com/blogs/isv/2015/04/field-audit-trail-briefing-isvs.html">Field Audit Trail</a> (FAT). In Salesforce, there&rsquo;s an option that allows you to track changes made to fields (either directly by users through a web UI or mobile device, or via other applications through the API). This historical data is composed of &ldquo;before&rdquo; and &ldquo;after&rdquo; values for every tracked field of an object. These stick around for a long time, as they&rsquo;re a matter of historical record. That means that if you have data that changes very frequently, this data set can grow rapidly, and without any particular bound. So we use HBase as a destination for moving older sets of audit data over, so it&rsquo;s still accessible via the API, but doesn&rsquo;t have any cost to the relational database optimizer. The same principle applies to other data that behaves the same way; we can archive this data into HBase as a cold store.</p>
<p style="text-align: justify;">Another part of shield that uses HBase is the <a href="https://www.youtube.com/watch?v=UydKm0QIiiE&amp;app=desktop">Event Monitoring</a> feature. The initial deployment was based on Hadoop, and culls a subset of application log lines, making them available to customers directly as downloadable files. New work is in progress to capture some event data into HBase, like Login Forensics, in real time, so it can be queried interactively. This could be useful for security and audit, limit monitoring, and general usage tracking. We&rsquo;re also introducing an asynchronous way to query this data so you can work with the potentially large resulting data sets in sensible ways.</p>
<p style="text-align: justify;">More generally, the Platform teams at Salesforce have been cooking up a general way for customers to use HBase. It&rsquo;s called BigObjects (more <a href="https://developer.salesforce.com/releases/release/Summer15/big+objects">here</a>). BigObjects behave in most (but not all) ways like standard relational-database-backed objects, and are ideally suited for use cases that require ingesting large amounts of read-only data from external systems: log files, POS data, event data, clickstreams, etc.</p>
<p style="text-align: justify;">We&rsquo;re adding more features that use HBase in every release, like improving mention relevancy in Chatter, tracking Apex unit test results, caching report data, and more. We&rsquo;ll post follow-ups here and on the <a href="https://medium.com/salesforce-engineering">Salesforce Engineering Medium Channel</a> about these as they evolve.</p>
<h3>Contributing To HBase</h3>
<p style="text-align: justify;">So, we&rsquo;ve got HBase clusters running in data centers all over the world, powering new features in the product, and running on commodity hardware that can scale linearly.</p>
<p style="text-align: justify;">But perhaps more importantly, Salesforce has put a premium on not just being a user of HBase, but also being a contributor. The company employs multiple committers on the Apache project, including both of us (Lars is a committer and PMC member, and Andrew is an Apache VP and PMC Chair). We&rsquo;ve written and committed hundreds of patches, including some major features. As committers, we&rsquo;ve reviewed and committed thousands of patches, and served as release managers for the 0.94 release (Lars) and 0.98 release (Andrew). </p>
<p style="text-align: justify;">We&rsquo;ve also presented dozens of talks at conferences about HBase, including HBaseCon and OSCON.</p>
<p style="text-align: justify;">We&rsquo;re committed to doing our work in the community, not in a private fork except where temporarily needed for critical issues. That&rsquo;s a key tenet of the team&rsquo;s OSS philosophy &mdash; no forking! &mdash; that we&rsquo;ll talk about more in an upcoming post on the Salesforce Engineering Medium Channel.</p>
<p style="text-align: justify;">By the way, outside of the Core deployment of HBase that we&rsquo;ve described here, there are actually a number of other places in the larger Salesforce universe where HBase is deployed as well, including Data.com, the Marketing Cloud (more <a href="https://www.youtube.com/watch?v=1o-zb5Qy51s">here</a>), and <a href="https://medium.com/salesforce-open-source/argus-time-series-monitoring-and-alerting-d2941f67864">Argus</a>, an internal time-series monitoring service. More on these uses soon, too!</p>
<h3 style="text-align: justify;">Conclusion</h3>
<p style="text-align: justify;">We&rsquo;re happy to have been a contributing part of the HBase community these last few years, and we&rsquo;re looking forward to even more good stuff to come. </p></p>
