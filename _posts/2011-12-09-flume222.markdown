---
layout: post
title: Apache Flume - Architecture of Flume NG
date: '2011-12-09T18:30:16+00:00'
categories: flume
---
<div style="background-color: transparent; "> 
    <p><span style="font-size: 15px; font-family: Arial; background-color: transparent; text-decoration: none; vertical-align: baseline; white-space: pre-wrap; ">Apache Flume is a distributed, reliable, and available system for efficiently collecting, aggregating and moving large amounts of log data from many different sources to a centralized data store. Flume is currently undergoing incubation at The Apache Software Foundation. More information on this project can be found at </span><a href="http://incubator.apache.org/flume"><span style="font-size: 15px; font-family: Arial; color: #000099; background-color: transparent; text-decoration: underline; vertical-align: baseline; white-space: pre-wrap; ">http://incubator.apache.org/flume</span></a><span style="font-size: 15px; font-family: Arial; background-color: transparent; text-decoration: none; vertical-align: baseline; white-space: pre-wrap; ">. <i>Flume NG</i> is work related to new major revision of Flume and is the subject of this post.</span><br /><span style="font-size: 15px; font-family: Arial; background-color: transparent; text-decoration: none; vertical-align: baseline; white-space: pre-wrap; "></span><br /><span style="font-size: 15px; font-family: Arial; background-color: transparent; text-decoration: none; vertical-align: baseline; white-space: pre-wrap; ">Prior to entering the incubator, Flume saw incremental releases leading up to version 0.9.4. As Flume became adopted it became clear that certain design choices would need to be reworked in order to address problems reported in the field. The work necessary to make this change began a few months ago under the JIRA issue </span><a href="https://issues.apache.org/jira/browse/FLUME-728"><span style="font-size: 15px; font-family: Arial; color: #000099; background-color: transparent; text-decoration: underline; vertical-align: baseline; white-space: pre-wrap; ">FLUME-728</span></a><span style="font-size: 15px; font-family: Arial; background-color: transparent; text-decoration: none; vertical-align: baseline; white-space: pre-wrap; ">. This work currently resides on a separate branch by the name </span><span style="font-size: 15px; font-family: Arial; background-color: transparent; font-style: italic; text-decoration: none; vertical-align: baseline; white-space: pre-wrap; ">flume-728</span><span style="font-size: 15px; font-family: Arial; background-color: transparent; text-decoration: none; vertical-align: baseline; white-space: pre-wrap; ">, and is informally referred to as Flume NG. At the time of writing this post Flume NG had gone through two internal milestones - <i>NG Alpha 1</i>, and <i>NG Alpha 2</i> and a formal incubator release of Flume NG is in the works.</span><br /><span style="font-size: 15px; font-family: Arial; background-color: transparent; text-decoration: none; vertical-align: baseline; white-space: pre-wrap; "></span><br /><span style="font-size: 15px; font-family: Arial; background-color: transparent; text-decoration: none; vertical-align: baseline; white-space: pre-wrap; ">At a high-level, Flume NG uses a single-hop message delivery guarantee semantics to provide end-to-end reliability for the system. To accomplish this, certain new concepts have been incorporated into its design, while certain other existing concepts have been either redefined, reused or dropped completely.</span><br /><span style="font-size: 15px; font-family: Arial; background-color: transparent; text-decoration: none; vertical-align: baseline; white-space: pre-wrap; "></span><br /><span style="font-size: 15px; font-family: Arial; background-color: transparent; text-decoration: none; vertical-align: baseline; white-space: pre-wrap; ">In this blog post, I will describe the fundamental concepts incorporated in Flume NG and talk about it’s high-level architecture. This is a first in a series of blog posts by Flume team that will go into further details of it’s design and implementation.</span></p> 
    <div style="background-color: transparent; "> 
      <h3><span id="internal-source-marker_0.03839341760613024" style="font-size: 15px; font-family: Arial; background-color: transparent; font-weight: bold; text-decoration: none; vertical-align: baseline; white-space: pre-wrap; ">Core Concepts</span></h3><span style="font-size: 15px; font-family: Arial; background-color: transparent; text-decoration: none; vertical-align: baseline; white-space: pre-wrap; "></span><br /><span style="font-size: 15px; font-family: Arial; background-color: transparent; text-decoration: none; vertical-align: baseline; white-space: pre-wrap; ">The purpose of Flume is to provide a distributed, reliable, and available system for efficiently collecting, aggregating and moving large amounts of log data from many different sources to a centralized data store. The architecture of Flume NG is based on a few concepts that together help achieve this objective. Some of these concepts have existed in the past implementation, but have changed drastically. Here is a summary of concepts that Flume NG introduces, redefines, or reuses from earlier implementation:</span><br /><span style="font-size: 15px; font-family: Arial; background-color: transparent; text-decoration: none; vertical-align: baseline; white-space: pre-wrap; "></span> 
      <ul> 
        <li style="list-style-type: disc; font-size: 15px; font-family: Arial; background-color: transparent; text-decoration: none; vertical-align: baseline; "><span style="background-color: transparent; font-weight: bold; text-decoration: none; vertical-align: baseline; white-space: pre-wrap; ">Event: </span><span style="background-color: transparent; text-decoration: none; vertical-align: baseline; white-space: pre-wrap; ">A byte payload with optional string headers that represent the unit of data that Flume can transport from it’s point of origination to it’s final destination.</span></li> 
        <li style="list-style-type: disc; font-size: 15px; font-family: Arial; background-color: transparent; text-decoration: none; vertical-align: baseline; "><span style="background-color: transparent; font-weight: bold; text-decoration: none; vertical-align: baseline; white-space: pre-wrap; ">Flow:</span><span style="background-color: transparent; text-decoration: none; vertical-align: baseline; white-space: pre-wrap; "> Movement of events from the point of origin to their final destination is considered a data flow, or simply flow. This is not a rigorous definition and is used only at a high level for description purposes. </span></li> 
        <li style="list-style-type: disc; font-size: 15px; font-family: Arial; background-color: transparent; text-decoration: none; vertical-align: baseline; "><span style="background-color: transparent; font-weight: bold; text-decoration: none; vertical-align: baseline; white-space: pre-wrap; ">Client: </span><span style="background-color: transparent; text-decoration: none; vertical-align: baseline; white-space: pre-wrap; ">An interface implementation that operates at the point of origin of events and delivers them to a Flume agent. Clients typically operate in the process space of the application they are consuming data from. For example, </span><span style="background-color: transparent; font-style: italic; text-decoration: none; vertical-align: baseline; white-space: pre-wrap; ">Flume Log4j Appender</span><span style="background-color: transparent; text-decoration: none; vertical-align: baseline; white-space: pre-wrap; "> is a client.</span></li> 
        <li style="list-style-type: disc; font-size: 15px; font-family: Arial; background-color: transparent; text-decoration: none; vertical-align: baseline; "><span style="background-color: transparent; font-weight: bold; text-decoration: none; vertical-align: baseline; white-space: pre-wrap; ">Agent:</span><span style="background-color: transparent; text-decoration: none; vertical-align: baseline; white-space: pre-wrap; "> An independent process that hosts flume components such as sources, channels and sinks, and thus has the ability to receive, store and forward events to their next-hop destination. </span></li> 
        <li style="list-style-type: disc; font-size: 15px; font-family: Arial; background-color: transparent; text-decoration: none; vertical-align: baseline; "><span style="background-color: transparent; font-weight: bold; text-decoration: none; vertical-align: baseline; white-space: pre-wrap; ">Source:</span><span style="background-color: transparent; text-decoration: none; vertical-align: baseline; white-space: pre-wrap; "> An interface implementation that can consume events delivered to it via a specific mechanism. For example, an Avro source is a source implementation that can be used to receive Avro events from clients or other agents in the flow. When a source receives an event, it hands it over to one or more channels.</span></li> 
        <li style="list-style-type: disc; font-size: 15px; font-family: Arial; background-color: transparent; text-decoration: none; vertical-align: baseline; "><span style="background-color: transparent; font-weight: bold; text-decoration: none; vertical-align: baseline; white-space: pre-wrap; ">Channel:</span><span style="background-color: transparent; text-decoration: none; vertical-align: baseline; white-space: pre-wrap; "> A transient store for events, where events are delivered to the channel via sources operating within the agent. An event put in a channel stays in that channel until a sink removes it for further transport. An example of channel is the JDBC channel that uses a file-system backed embedded database to persist the events until they are removed by a sink. Channels play an important role in ensuring durability of the flows.</span></li> 
        <li style="list-style-type: disc; font-size: 15px; font-family: Arial; background-color: transparent; text-decoration: none; vertical-align: baseline; "><span style="background-color: transparent; font-weight: bold; text-decoration: none; vertical-align: baseline; white-space: pre-wrap; ">Sink:</span><span style="background-color: transparent; text-decoration: none; vertical-align: baseline; white-space: pre-wrap; "> An interface implementation that can remove events from a channel and transmit them to the next agent in the flow, or to the event’s final destination. Sinks that transmit the event to it’s final destination are also known as terminal sinks. The </span><span style="background-color: transparent; font-style: italic; text-decoration: none; vertical-align: baseline; white-space: pre-wrap; ">Flume HDFS sink</span><span style="background-color: transparent; text-decoration: none; vertical-align: baseline; white-space: pre-wrap; "> is an example of a terminal sink. Whereas the Flume Avro sink is an example of a regular sink that can transmit messages to other agents that are running an Avro source.</span></li> 
      </ul> 
    </div> 
    <p><span style="font-family: Arial; font-size: 15px; white-space: pre-wrap; ">These concepts help in simplifying the architecture, implementation, configuration and deployment of Flume. </span></p> 
    <div style="background-color: transparent; "> 
      <h3><span id="internal-source-marker_0.03839341760613024" style="font-size: 15px; font-family: Arial; background-color: transparent; font-weight: bold; text-decoration: none; vertical-align: baseline; white-space: pre-wrap; ">Flow Pipeline</span></h3><span style="font-size: 15px; font-family: Arial; background-color: transparent; text-decoration: none; vertical-align: baseline; white-space: pre-wrap; "></span><br /><span style="font-size: 15px; font-family: Arial; background-color: transparent; text-decoration: none; vertical-align: baseline; white-space: pre-wrap; ">A flow in Flume NG starts from the client. The client transmits the event to it’s next hop destination. This destination is an agent. More precisely, the destination is a source operating within the agent. The source receiving this event will then deliver it to one or more channels. The channels that receive the event are drained by one or more sinks operating within the same agent. If the sink is a regular sink, it will forward the event to it’s next-hop destination which will be another agent. If instead it is a terminal sink, it will forward the event to it’s final destination. Channels allow the decoupling of sources from sinks using the familiar producer-consumer model of data exchange. This allows sources and sinks to have different performance and runtime characteristics and yet be able to effectively use the physical resources available to the system. </span><br /><span style="font-size: 15px; font-family: Arial; background-color: transparent; text-decoration: none; vertical-align: baseline; white-space: pre-wrap; "></span><br /> 
    </div> 
    <p><span style="font-family: Arial; font-size: 15px; white-space: pre-wrap; ">Figure 1 below shows how the various components interact with each other within a flow pipeline.</span> </p> 
    <p style="text-align: center; "><img src="https://blogs.apache.org/flume/mediaresource/ab0d50f6-a960-42cc-971e-3da38ba3adad" alt="Schematic showing logical components in a flow. The arrows represent the direction in which events travel across the system. This also illustrates how flows can fan-out by having one source write the event out to multiple channels." /> </p> 
    <p> </p> 
    <p style="text-align: center; "> <span style="text-align: center; background-color: transparent; font-size: 15px; font-family: Arial; font-weight: bold; font-style: italic; text-decoration: none; vertical-align: baseline; white-space: pre-wrap; ">Figure 1: </span><span style="text-align: center; background-color: transparent; font-size: 15px; font-family: Arial; font-style: italic; text-decoration: none; vertical-align: baseline; white-space: pre-wrap; ">Schematic showing logical components in a flow. The arrows represent the direction in which events travel across the system. This also illustrates how flows can fan-out by having one source write the event out to multiple channels.</span></p> 
    <p> </p> 
    <div style="background-color: transparent; "><span id="internal-source-marker_0.03839341760613024" style="font-size: 15px; font-family: Arial; background-color: transparent; text-decoration: none; vertical-align: baseline; white-space: pre-wrap; ">By configuring a source to deliver the event to more than one channel, flows can fan-out to more than one destination. This is illustrated in Figure 1 where the source within the operating Agent writes the event out to two channels - Channel 1 and Channel 2.</span><br /><span style="font-size: 15px; font-family: Arial; background-color: transparent; text-decoration: none; vertical-align: baseline; white-space: pre-wrap; "></span><br /></div> 
    <p><span style="font-family: Arial; font-size: 15px; white-space: pre-wrap; ">Conversely, flows can be converged by having multiple sources operating within the same agent write to the same channel. A example of the physical layout of a converging flow is show in Figure 2 below.</span></p> 
    <p> </p> 
    <p style="text-align: center; "><img src="https://blogs.apache.org/flume/mediaresource/268bf8db-43c7-497b-a0ef-63c482371eef" alt=" A simple converging flow on Flume NG." /> </p> 
    <p style="text-align: center; "> <span style="text-align: center; background-color: transparent; font-size: 15px; font-family: Arial; font-weight: bold; font-style: italic; text-decoration: none; vertical-align: baseline; white-space: pre-wrap; ">Figure 2:</span><span style="text-align: center; background-color: transparent; font-size: 15px; font-family: Arial; font-style: italic; text-decoration: none; vertical-align: baseline; white-space: pre-wrap; "> A simple converging flow on Flume NG.</span></p> 
    <p> </p> 
    <h3><span style="font-family: Arial; font-size: 15px; font-weight: bold; white-space: pre-wrap; ">Reliability and Failure Handling</span></h3> 
    <div style="background-color: transparent; "> 
      <p><span style="font-size: 15px; font-family: Arial; background-color: transparent; text-decoration: none; vertical-align: baseline; white-space: pre-wrap; "></span><br /><span style="font-size: 15px; font-family: Arial; background-color: transparent; text-decoration: none; vertical-align: baseline; white-space: pre-wrap; ">Flume NG uses channel-based transactions to guarantee reliable message delivery. When a message moves from one agent to another, two transactions are started, one on the agent that delivers the event and the other on the agent that receives the event. In order for the sending agent to commit it’s transaction, it must receive success indication from the receiving agent. The receiving agent only returns a success indication if it’s own transaction commits properly first. This ensures guaranteed delivery semantics between the hops that the flow makes. Figure 3 below shows a sequence diagram that illustrates the relative scope and duration of the transactions operating within the two interacting agents.</span></p> 
      <p style="text-align: center; "><img src="https://blogs.apache.org/flume/mediaresource/a15d9347-da9e-4824-b45f-6c00f0720590" alt="Transactional exchange of events between agents." /> </p> 
      <p style="text-align: center; "> <span style="text-align: center; background-color: transparent; font-size: 15px; font-family: Arial; font-weight: bold; font-style: italic; text-decoration: none; vertical-align: baseline; white-space: pre-wrap; ">Figure 3: </span><span style="text-align: center; background-color: transparent; font-size: 15px; font-family: Arial; font-style: italic; text-decoration: none; vertical-align: baseline; white-space: pre-wrap; ">Transactional exchange of events between agents.</span></p> 
      <p> </p> 
      <div style="background-color: transparent; "><span id="internal-source-marker_0.03839341760613024" style="font-size: 15px; font-family: Arial; background-color: transparent; text-decoration: none; vertical-align: baseline; white-space: pre-wrap; ">This mechanism also forms the basis for failure handling in Flume NG. When a flow that passes through many different agents encounters a communication failure on any leg of the flow, the affected events start getting buffered at the last unaffected agent in the flow. If the failure is not resolved on time, this may lead to the failure of the last unaffected agent, which then would force the agent before it to start buffering the events. Eventually if the failure occurs when the client transmits the event to its first-hop destination, the failure will be reported back to the client which can then allow the application generating the events to take appropriate action.</span><br /><span style="font-size: 15px; font-family: Arial; background-color: transparent; text-decoration: none; vertical-align: baseline; white-space: pre-wrap; "></span><br /></div> 
      <p><span style="font-family: Arial; font-size: 15px; white-space: pre-wrap; ">On the other hand, if the failure is resolved before the first-hop agent fails, the buffered events in various agents downstream will start draining towards their destination. Eventually the flow will be restored to its original characteristic throughput levels. Figure 4 below illustrates a scenario where a flow comprising of two intermediary agents between the client and the central store go through a transient failure. The failure occurs between agent 2 and the central store, resulting in the events getting buffered at the agent 2 itself. Once the failing link has been restored to normal, the buffered events drain out to the central store and the flow is restored to its original throughput characteristics.</span></p> 
      <p style="text-align: center; "><img src="https://blogs.apache.org/flume/mediaresource/ac9d1c83-1089-4730-9546-fe8de509b34c" alt="Failure handling in flows. In (a) the flow is normal and events can travel from the client to the central store. In (b) a communication failure occurs between Agent 2 and the event store resulting in events being buffered on Agent 2. In (c) the cause of failure was addressed and the flow was restored and any events buffered in Agent 2 were drained to the store." /> </p> 
      <p style="text-align: center; "> <span style="text-align: center; background-color: transparent; font-size: 15px; font-family: Arial; font-weight: bold; font-style: italic; text-decoration: none; vertical-align: baseline; white-space: pre-wrap; ">Figure 4: </span><span style="text-align: center; background-color: transparent; font-size: 15px; font-family: Arial; font-style: italic; text-decoration: none; vertical-align: baseline; white-space: pre-wrap; ">Failure handling in flows. In (a) the flow is normal and events can travel from the client to the central store. In (b) a communication failure occurs between Agent 2 and the event store resulting in events being buffered on Agent 2. In (c) the cause of failure was addressed and the flow was restored and any events buffered in Agent 2 were drained to the store.</span></p> 
      <p> </p> 
      <div style="background-color: transparent; "> 
        <h3><span id="internal-source-marker_0.03839341760613024" style="font-size: 15px; font-family: Arial; background-color: transparent; font-weight: bold; text-decoration: none; vertical-align: baseline; white-space: pre-wrap; ">Wrapping up</span></h3> 
      </div> 
      <p><span style="font-family: Arial; font-size: 15px; white-space: pre-wrap; ">In this post I described the various concepts that are a part of Flume NG and its high-level architecture. This is first of a series of posts from the Flume team that will highlight the design and implementation of this system. In the meantime, if you need anymore information, please feel free to drop an email on the project’s user or developer lists, or alternatively file the appropriate JIRA issues. Your contribution in any form is welcome on the project.</span> </p> 
      <p> </p> 
      <div style="background-color: transparent; "> 
        <h3><span id="internal-source-marker_0.03839341760613024" style="font-size: 15px; font-family: Arial; background-color: transparent; font-weight: bold; text-decoration: none; vertical-align: baseline; white-space: pre-wrap; ">Links:</span></h3> 
        <p><span style="font-size: 15px; font-family: Arial; background-color: transparent; text-decoration: none; vertical-align: baseline; white-space: pre-wrap; "></span><br /><span style="font-size: 15px; font-family: Arial; background-color: transparent; text-decoration: none; vertical-align: baseline; white-space: pre-wrap; ">Project Website: </span><a href="http://incubator.apache.org/flume/"><span style="font-size: 15px; font-family: Arial; color: #000099; background-color: transparent; text-decoration: underline; vertical-align: baseline; white-space: pre-wrap; ">http://incubator.apache.org/flume/</span></a></p> 
        <p><span style="font-size: 15px; font-family: Arial; background-color: transparent; text-decoration: none; vertical-align: baseline; white-space: pre-wrap; ">Flume NG Getting Started Guide: </span><a href="https://cwiki.apache.org/confluence/display/FLUME/Getting+Started"><span style="font-size: 15px; font-family: Arial; color: #000099; background-color: transparent; text-decoration: underline; vertical-align: baseline; white-space: pre-wrap; ">https://cwiki.apache.org/confluence/display/FLUME/Getting+Started</span></a></p> 
        <p><span style="font-size: 15px; font-family: Arial; background-color: transparent; text-decoration: none; vertical-align: baseline; white-space: pre-wrap; ">Mailing Lists: </span><a href="http://incubator.apache.org/flume/mail-lists.html"><span style="font-size: 15px; font-family: Arial; color: #000099; background-color: transparent; text-decoration: underline; vertical-align: baseline; white-space: pre-wrap; ">http://incubator.apache.org/flume/mail-lists.html</span></a></p> 
        <p><span style="font-size: 15px; font-family: Arial; background-color: transparent; text-decoration: none; vertical-align: baseline; white-space: pre-wrap; ">Issue Tracking: </span><a href="https://issues.apache.org/jira/browse/FLUME"><span style="font-size: 15px; font-family: Arial; color: #000099; background-color: transparent; text-decoration: underline; vertical-align: baseline; white-space: pre-wrap; ">https://issues.apache.org/jira/browse/FLUME</span></a></p> 
      </div> 
      <p><span style="font-family: Arial; font-size: 15px; white-space: pre-wrap; ">IRC Channel: #flume on irc.freenode.net</span> </p> 
      <p> </p> 
      <p> </p> 
    </div> 
    <p> </p> 
    <p> </p> 
    <p> </p> 
  </div>
