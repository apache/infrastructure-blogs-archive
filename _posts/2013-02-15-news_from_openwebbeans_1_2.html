---
layout: post
status: PUBLISHED
published: true
title: News from OpenWebBeans-1.2.0
author:
  display_name: Mark Struberg
  login: struberg
  email: struberg@apache.org
author_login: struberg
author_email: struberg@apache.org
id: 17fda96c-1eb3-43fd-a939-4f4f83b80c29
date: '2013-02-15 20:44:31 -0500'
categories:
- Status
tags:
- java
- owb
- javaee
- cdi
comments: []
permalink: owb/entry/news_from_openwebbeans_1_2
---
<p>The Apache OpenWebBeans team has been quite busy with big refactorings. Big improvements have been made to the proxying mechanism, the Bean scanning and the AnnotatedType handling. We managed to improve the overall performance again and now deliver almost native Java like performance for our NormalScoping proxies.</p>
<h3>Parts which are already implemented</h3>
<p>Let's take a close look at a few details of the parts we already finished and explain them briefly.</p>
<h5>Split between NormalScoping Proxies and Interceptor Proxies</h5>
<p>In OpenWebBeans 1.0.x and 1.1.x a single Bean only had one single Proxy handling for all tasks - The NormalScopedBeanInterceptorHandler. This did handle all the stuff like Interceptors, Decorators provide subclassing for abstract Decorators but also did the NormalScope handling. </p>
<p>As result of this unified handling we only stored the native Contextual Instances in the Contexts (Session, Request map, Conversation map, etc). The negative side effect of this approach was that we had to introduce a quite hacky mechanism to regain access to the CreationalContext. Needless to say that this was not only complex but also error prone.</p>
<p>In OpenWebBeans-1.2.0 we now maintain 2 proxies. The first one solely handles NormalScoping, then 2nd one does all the Interceptor and Decorator stuff. The most important change is that we apply the DecoratorProxy directly 1:1 on the Contextual Instance and thus don't need to do any of those weird CreationalContext hacks anymore. Instead the already intercepted/decorated instance gets stored in the Context.</p>
<p> All NormalScope proxies now implement the Interface <i>OwbNormalScopeProxy</i> and have a name <i>*$OwbNormalScopeProxy*</i>.</p>
<p> All Interceptor and/or Decorator proxies implement the Interface <i>OwbInterceptorProxy</i> and have a name <i>*$OwbInterceptProxy*</i>.</p>
<p>Additionally to those 2 proxies we also introduced a new separate proxy kind for creating subclasses for abstract Decorators which now implement the marker interface <i>OwbDecoratorProxy</i>.</p>
<h5>Creating our own proxy bytecode</h5>
<p> For performance reasons we moved from using Javassist (where we fixed quite a few mem leaks in the past) to generating our own native Java ByteCode with ASM. We now only use reflection if really necessary. For standard NormalScoping of public methods we e.g. generate the following code. Consider a simple User class:</p>
<pre>public class User {
   public String getGivenName() { return "Hans"; }
}
</pre>
<p>For this class the generated bytecode of an OwbNormalScopeProxy will look like the following:</p>
<pre>public class User$OwbNormalScopeProxy0 extends User {
  private Provider<user> owbContextualInstanceProvider;
 
  public String getGivenName() {
    return owbContextualInstanceProvider.get().getGivenName();
  }
}
</user></pre>
<p>There is no bells and whistle and especially no reflection - just pure plain Java bytecode which is blazingly fast!</p>
<p>Btw, we do very similar stuff for non-intercepted methods of intercepted/decorated classes. And we also improved the handling of intercepted methods and are now more than twice as fast as OWB-1.1.7 (which was already very fast).&nbsp; </p>
<h5>Cleaning up the Bean creation<br /></h5>
<p>In the past we had 2 ways to create beans. If an Extension used ProcessAnnotatedType to tweak the AnnotatedType of a class then we built the <i>Bean<T></i> from the modified <i>AnnotatedType<T></i>. For cases where the AnnotatedType did not get modified we took a completely different part and created the Bean from the Class reflection information. This part came from a time where there was no AnnotatedType in the spec yet.</p>
<p>In OWB-1.2.0 we now do all the Bean<T> construction based on the AnnotatedType - regardless if it got provided by a CDI-Extension or remained unchanged. This made our codebase much easier to maintain! Arne also did a great job by introducing and cleaning up all the BeanBuilders and making the final Bean<T> immutable.</p>
<h3>Parts waiting to be done <br /></h3>
<p>More new things to come before the release:</p>
<ul>
<li>Replace Scannotation by xbean-finder.</li>
<li> Create the initial AnnotatedTypes from the information already collected by xbean-finder instead of doing expensive Class reflection. </li>
</ul>
<h3>CDI-1.0 or CDI-1.1?</h3>
<p> We initially targeted CDI-1.1 with this release. But during the development we figured that we do not yet need to. All the parts introduced so far are perfectly working with CDI-1.0 as well. Thus it looks like we gonna release OWB-1.2.0 as still being CDI-1.0. But we are well prepared to support the new features of CDI-1.1 very quickly as we already did all the preparations. Sometimes we internally already use CDI-1.1 mechanisms (like the BeanAttributs) and only have to add 'implements RandomCdi11FeatureInterface'. This will likely be shipped as OWB-2.0.0 though when the spec hits an almost final status and the TCK is available. </p>
<h3>How to Test<br /></h3>
<p>That's a pretty easy thing. If you have the <a title="apache.snapshots maven repo" href="https://repository.apache.org/content/groups/snapshots/org/apache/openwebbeans/">apache.snapshots maven repo</a> in your build, then you can just reference owb 1.2.0-SNAPSHOT in your build and you're done!</p>
