---
layout: post
status: PUBLISHED
published: true
title: HBase ZK-less Region Assignment
author:
  display_name: Michael Stack
  login: stack
  email: stack@apache.org
author_login: stack
author_email: stack@apache.org
excerpt: '<span style="text-align: justify; font-size: 15px; font-family: Arial; font-style:
  italic; vertical-align: baseline; background-color: transparent;">ZK-less region
  assignment&nbsp;</span><span style="text-align: justify; font-size: 15px; font-family:
  Arial; vertical-align: baseline; background-color: transparent;">allows us to achieve
  greater scale as well as do faster startups and assignment. It is simpler and has
  less code, improves the speed at which assignments run so we can do faster rolling
  restarts. This feature will be on by default in HBase 2.0.0.</span>'
id: a8e44b2d-ccd6-4792-9e09-295c3b4efbed
date: '2015-03-05 17:59:37 -0500'
categories:
- General
tags:
- assignment
- zookeeper
- hbase
comments: []
permalink: hbase/entry/hbase_zk_less_region_assignment
---
<h2 dir="ltr" style="line-height: 1.38; margin-top: 10pt; margin-bottom: 0pt; text-align: justify;" id="docs-internal-guid-4af3c316-eb13-8064-a44d-4bf463121ce7"><span style="font-family: Arial; font-size: 15px; line-height: 1.38; font-weight: normal; background-color: transparent;"><i>Jimmy Xiang,&nbsp;</i></span><i style="letter-spacing: -0.018em; line-height: 1.38;"><span style="font-family: Arial; font-size: 15px; font-weight: normal; line-height: 1.38; letter-spacing: -0.018em; background-color: transparent;">HBase Committer</span></i></h2>
<p dir="ltr" style="line-height: 1.38; margin-top: 0pt; margin-bottom: 0pt; text-align: justify;"><span style="font-size: 16px; font-family: 'Trebuchet MS'; color: #666666; font-weight: bold; vertical-align: baseline; background-color: transparent;">Introduction</span></p>
<p> </p>
<p dir="ltr" style="line-height: 1.38; margin-top: 0pt; margin-bottom: 0pt; text-align: justify;"><span style="font-size: 15px; font-family: Arial; vertical-align: baseline; background-color: transparent;">Recently, we changed how HBase assigns regions. This architectural change is referred to as </span><span style="font-size: 15px; font-family: Arial; font-style: italic; vertical-align: baseline; background-color: transparent;">ZK-less region assignment</span><span style="font-size: 15px; font-family: Arial; vertical-align: baseline; background-color: transparent;">, i.e. assigning regions without involving ZooKeeper. The change allows us to achieve greater scale as well as faster startups and assignment. It is simpler and has less code, improves the speed at which assignments run so we can do faster rolling restarts. The master is also re-architected to handle more regions. This feature will be on by default in HBase 2.0.0.</span></p>
<p> </p>
<p dir="ltr" style="line-height: 1.38; margin-top: 0pt; margin-bottom: 0pt; text-align: justify;"><span style="font-size: 15px; font-family: Arial; vertical-align: baseline; background-color: transparent;">This post presents the architectural evolution and explains the background that brought on the change. Some performance test results follow. At the end, we briefly discuss some tradeoffs made.</span></p>
<p> </p>
<h3 dir="ltr" style="line-height: 1.38; margin-top: 8pt; margin-bottom: 0pt; text-align: justify;"><span style="font-size: 16px; font-family: 'Trebuchet MS'; color: #666666; vertical-align: baseline; background-color: transparent;">Architectural Evolution</span></h3>
<p> </p>
<p dir="ltr" style="line-height: 1.38; margin-top: 0pt; margin-bottom: 0pt; text-align: justify;"><span style="font-size: 15px; font-family: Arial; vertical-align: baseline; background-color: transparent;">Apache HBase is a Google </span><a href="http://research.google.com/archive/bigtable.html"><span style="font-size: 15px; font-family: Arial; color: #1155cc; text-decoration: underline; vertical-align: baseline; background-color: transparent;">Bigtable</span></a><span style="font-size: 15px; font-family: Arial; vertical-align: baseline; background-color: transparent;">-like NoSQL database on Apache Hadoop and HDFS. A typical HBase cluster (releases 0.90 up through 1.0) had one active Master, several backup Masters, and a list of RegionServers. RegionServers host regions that serve table data. The active Master is responsible for assigning regions to RegionServers (refer to the HBase </span><a href="http://hbase.apache.org/book/architecture.html"><span style="font-size: 15px; font-family: Arial; color: #1155cc; text-decoration: underline; vertical-align: baseline; background-color: transparent;">architecture</span></a><span style="font-size: 15px; font-family: Arial; vertical-align: baseline; background-color: transparent;"> for more information).</span></p>
<p> </p>
<p dir="ltr" style="line-height: 1.38; margin-top: 0pt; margin-bottom: 0pt; text-align: justify;"><span style="font-size: 15px; font-family: Arial; vertical-align: baseline; background-color: transparent;">In the blog post </span><a href="http://blog.cloudera.com/blog/2012/11/apache-hbase-assignmentmanager-improvements/"><span style="font-size: 15px; font-family: Arial; color: #1155cc; text-decoration: underline; vertical-align: baseline; background-color: transparent;">Apache HBase AssignmentManager Improvements</span></a><span style="font-size: 15px; font-family: Arial; vertical-align: baseline; background-color: transparent;">, we talked about AssignmentManager and some region assignment details. Most of the improvements made it into the HBase 0.96.0 release. With these improvements, and many others, 0.96 is the first release that </span><a href="https://issues.apache.org/jira/browse/HBASE-8031"><span style="font-size: 15px; font-family: Arial; color: #1155cc; text-decoration: underline; vertical-align: baseline; background-color: transparent;">IntegrationTestBigLinkedList</span></a><span style="font-size: 15px; font-family: Arial; vertical-align: baseline; background-color: transparent;"> (a test that ensures no data loss at scale similar to </span><a href="https://github.com/keith-turner/goraci"><span style="font-size: 15px; font-family: Arial; color: #1155cc; text-decoration: underline; vertical-align: baseline; background-color: transparent;">goraci</span></a><span style="font-size: 15px; font-family: Arial; vertical-align: baseline; background-color: transparent;">) &nbsp;passes &nbsp;without data loss or inconsistencies while our chaos monkey fault injection framework performs &nbsp;destructive actions. &nbsp;&nbsp;The cluster and its data is able to survive &nbsp;while chaos monkey is randomly moving/splitting/merging regions, restarting master/region servers, and dynamically modifying table schemas.</span></p>
<p> </p>
<p dir="ltr" style="line-height: 1.38; margin-top: 0pt; margin-bottom: 0pt; text-align: justify;"><span style="font-size: 15px; font-family: Arial; vertical-align: baseline; background-color: transparent;">Generally, HBase is considered to be much more stable since release 0.96/0.94. However, we have not changed how regions are assigned, not since we added ZooKeeper mediated assignment in HBase 0.90 (Before 0.90, region assignment didn&rsquo;t use ZooKeeper at all).</span></p>
<p> </p>
<p dir="ltr" style="line-height: 1.38; margin-top: 0pt; margin-bottom: 0pt; text-align: justify;"><span style="font-size: 15px; font-family: Arial; vertical-align: baseline; background-color: transparent;">Between releases 0.90 and 1.0, RegionServers used ZooKeeper to notify the Master about region assignment progress, and as a store for transient region transition states so that when the Master died, a new Master could pick up where old Master had left off. Once a region is opened, the RegionServer updates the meta table (a HBase system table that stores information about regions, such as start-key, location, etc.) with the new region location. The following graph shows the multiple interactions performed &nbsp;during the ZooKeeper based region assignments.</span></p>
<p dir="ltr" style="line-height: 1.38; margin-top: 0pt; margin-bottom: 0pt; text-align: center;"><span style="font-size: 15px; font-family: Arial; vertical-align: baseline; background-color: transparent;"><img src="https://lh3.googleusercontent.com/XKdCpvclqbNSdtdvkhUlaYDEFhZkCZRHrLXjp1jyyhmMSHwv1jVAPsceHdRnf3c1jNrDuRUb4IIOAht05XaRYtAYAkvFqWmUwBlusN29KLDsOHdl42ZCiarCEbdjLw7BWU9Kn9o" width="346" height="205" style="transform: rotate(0rad); -webkit-transform: rotate(0rad);" /></span></p>
<p dir="ltr" style="line-height: 1.38; margin-top: 0pt; margin-bottom: 0pt; text-align: justify;"><span style="font-size: 15px; font-family: Arial; vertical-align: baseline; background-color: transparent;">This graph does not look that complicated. However, to ensure consistent region states under many racing conditions, the code is quite complex. The following graph shows the interactions among entities involved in one region assignment.</span></p>
<p> </p>
<p dir="ltr" style="line-height: 1.38; margin-top: 0pt; margin-bottom: 0pt; text-align: center;"><span style="font-size: 15px; font-family: Arial; vertical-align: baseline; background-color: transparent;"><img src="https://lh5.googleusercontent.com/iy5fIdN08K40nRA_dEF0V-qlx4MH1meNUiT51OZV_IccSN8k0BB1FVegpiJ3T0Z6JgqA-YuiQuAzXAdyXXWFfZh06115fo_VPwVoWwYSUAelv3uk5EzIf1R8Qq-ehtlRBsqD2ow" width="529" height="255" style="transform: rotate(0rad); -webkit-transform: rotate(0rad);" /></span></p>
<p> </p>
<p dir="ltr" style="line-height: 1.38; margin-top: 0pt; margin-bottom: 0pt; text-align: justify;"><span style="font-size: 15px; font-family: Arial; vertical-align: baseline; background-color: transparent;">Due to the complexity of the existing region assignment logic, discussions on how to simplify how Master coordinated tasks are managed were started in </span><a href="https://issues.apache.org/jira/browse/HBASE-5487"><span style="font-size: 15px; font-family: Arial; color: #1155cc; text-decoration: underline; vertical-align: baseline; background-color: transparent;">HBASE-5487</span></a><span style="font-size: 15px; font-family: Arial; vertical-align: baseline; background-color: transparent;">. This JIRA is not just about region assignment. In this issue, the community started to discuss problems using ZooKeeper for region assignment. A popular idea was to put the meta table on the master (co-locating meta and master, see below for explanation), and assign regions without using ZooKeeper (ZK-less region assignment). With the meta table on the master, meta is always available to the master. The region states in Master memory acts as a cache for the meta table. This makes it easy to ensure that the meta and in-memory region states in Master are consistent at all times. All transient states are persisted in meta. Another benefit of not using ZooKeeper is that all region state transitions are reported to the Master synchronously. The state transition is confirmed by the Master right way. In this design, RegionServers cannot complete a region transition without first having approval from the Master. This also helps to maintain the region states integrity.</span></p>
<p> </p>
<p dir="ltr" style="line-height: 1.38; margin-top: 0pt; margin-bottom: 0pt; text-align: justify;"><span style="font-size: 15px; font-family: Arial; vertical-align: baseline; background-color: transparent;">These two suggestions were implemented in </span><a href="https://issues.apache.org/jira/browse/HBASE-10569"><span style="font-size: 15px; font-family: Arial; color: #1155cc; text-decoration: underline; vertical-align: baseline; background-color: transparent;">HBASE-10569</span></a><span style="font-size: 15px; font-family: Arial; vertical-align: baseline; background-color: transparent;"> and </span><a href="https://issues.apache.org/jira/browse/HBASE-11059"><span style="font-size: 15px; font-family: Arial; color: #1155cc; text-decoration: underline; vertical-align: baseline; background-color: transparent;">HBASE-11059</span></a><span style="font-size: 15px; font-family: Arial; vertical-align: baseline; background-color: transparent;"> in HBase 1.0. This new scheme is disabled by default in 1.0. In 2.0, ZooKeeper based region assignment is removed (</span><a href="https://issues.apache.org/jira/browse/HBASE-11611"><span style="font-size: 15px; font-family: Arial; color: #1155cc; text-decoration: underline; vertical-align: baseline; background-color: transparent;">HBASE-11611</span></a><span style="font-size: 15px; font-family: Arial; vertical-align: baseline; background-color: transparent;">). Currently in the master branch, for zk-less assignment to work, meta must be colocated on master but the intent is that by 2.0, this will no longer be required: i.e. meta can be anywhere on the cluster.</span></p>
<p> </p>
<h3 dir="ltr" style="line-height: 1.38; margin-top: 8pt; margin-bottom: 0pt; text-align: justify;"><span style="font-size: 16px; font-family: 'Trebuchet MS'; color: #666666; vertical-align: baseline; background-color: transparent;">Consistent Region States and the State Machine</span></h3>
<p> </p>
<p dir="ltr" style="line-height: 1.38; margin-top: 0pt; margin-bottom: 0pt; text-align: justify;"><span style="font-size: 15px; font-family: Arial; vertical-align: baseline; background-color: transparent;">In ZK-less (a.k.a RPC-based) region assignments, ZooKeeper isn&rsquo;t used any more to pass assignment information between the Master and RegionServers. &nbsp;Instead, all assignment state information is persisted and managed by the Master. RegionServers now notify the Master by making RPC calls to the Master directly. When a region is opened, instead of having the RegionServer update the meta table itself, now it just notifies the Master and the Master updates the meta table instead: i.e. one writer rather than many. The following graph shows the significantly simpler interactions during the RPC-based region assignments.</span></p>
<p> </p>
<p dir="ltr" style="line-height: 1.38; margin-top: 0pt; margin-bottom: 0pt; text-align: center;"><span style="font-size: 15px; font-family: Arial; vertical-align: baseline; background-color: transparent;"><img src="https://lh3.googleusercontent.com/OTZbAmUrBzTIUG9SoWNtWVCHKNVQ9q0BEQFjCzyqgFOwHTCq2oR1IRL0OrEpn5dJTZdTmwKs7xXwGZd4BEPfD8PSg-y4cbLVD2Tzb84XlRMCfQPOBX3APUfUT15hP1i6mPZxSUI" width="190" height="197" style="transform: rotate(0rad); -webkit-transform: rotate(0rad);" /></span></p>
<p> </p>
<p dir="ltr" style="line-height: 1.38; margin-top: 0pt; margin-bottom: 0pt; text-align: justify;"><span style="font-size: 15px; font-family: Arial; vertical-align: baseline; background-color: transparent;">With ZooKeeper based region assignments, the region state information is maintained in three places: ZooKeeper, meta table, and Master memory. ZooKeeper stores the region state transition information. Meta table stores the region location after a region is assigned. The Master tries to maintain the current/latest state of each region. Both Master and RegionServers can update the information in ZooKeeper. Only RegionServers update the region assignment information in meta table. The master updates region states before sending region assignment requests to region servers. The Master also gets region state updates based on the updated information in ZooKeeper and meta table.</span></p>
<p> </p>
<p dir="ltr" style="line-height: 1.38; margin-top: 0pt; margin-bottom: 0pt; text-align: justify;"><span style="font-size: 15px; font-family: Arial; vertical-align: baseline; background-color: transparent;">With RPC based region assignments, the region state information is maintained in two places: meta table, and Master memory. Only the Master updates the meta table. The Master makes sure the information in memory is consistent with the meta table.</span></p>
<p> </p>
<p dir="ltr" style="line-height: 1.38; margin-top: 0pt; margin-bottom: 0pt; text-align: justify;"><span style="font-size: 15px; font-family: Arial; vertical-align: baseline; background-color: transparent;">As discussed in the Master coordinated operations issue (</span><a href="https://issues.apache.org/jira/browse/HBASE-5487"><span style="font-size: 15px; font-family: Arial; color: #1155cc; text-decoration: underline; vertical-align: baseline; background-color: transparent;">HBASE-5487</span></a><span style="font-size: 15px; font-family: Arial; vertical-align: baseline; background-color: transparent;">), there are some tradeoffs against using ZooKeeper for region assignment:</span></p>
<p> </p>
<p dir="ltr" style="line-height: 1.38; margin-top: 0pt; margin-bottom: 0pt; text-align: justify;"><span style="font-size: 15px; font-family: Arial; vertical-align: baseline; background-color: transparent;">The Master does the region assignment based on the state in its memory. So the state in memory must be the latest. Otherwise, the Master could assign a region based on wrong information, which leads to problems such as region double assignment, stuck in transition, or not assigned at all.</span></p>
<p> </p>
<p dir="ltr" style="line-height: 1.38; margin-top: 0pt; margin-bottom: 0pt; text-align: justify;"><span style="font-size: 15px; font-family: Arial; vertical-align: baseline; background-color: transparent;">In ZooKeeper based region assignments, the state information in three places is not consistent all the time. We have to have complex logic to handle all kinds of racing problems to make sure we have reliable and consistent region assignment. The complexity in the logic and the interaction makes it hard to maintain, improve, or add new features. We don&rsquo;t even have a strict region state machine to follow in ZooKeeper based region assignments. &nbsp;With ZK-less region assignment, we have a strict region state machine now:</span></p>
<p> </p>
<p dir="ltr" style="line-height: 1.38; margin-top: 0pt; margin-bottom: 0pt; text-align: center;"><span style="font-size: 15px; font-family: Arial; vertical-align: baseline; background-color: transparent;"><img src="https://lh3.googleusercontent.com/lhITGnnyTc41ASWMP1lP1FUqE5Vx2s6GpPfu93x66h4Ly1nMIHeRn6exg07uGd5BHgcW_cGDXlimbBq0cWXSYnV7D1TN80YQJSxAsOD1tp1dIPnHw5rEg5VGOXWd30vNPV9EpUE" width="390" height="275" style="transform: rotate(0rad); -webkit-transform: rotate(0rad);" /></span></p>
<p> </p>
<p dir="ltr" style="line-height: 1.38; margin-top: 0pt; margin-bottom: 0pt;"><span style="font-size: 15px; font-family: Arial; vertical-align: baseline; background-color: transparent;">The state machine is documented in the HBase reference guide. You can find more information in patch </span><a href="https://issues.apache.org/jira/browse/HBASE-11961"><span style="font-size: 15px; font-family: Arial; color: #1155cc; text-decoration: underline; vertical-align: baseline; background-color: transparent;">HBASE-11961</span></a><span style="font-size: 15px; font-family: Arial; vertical-align: baseline; background-color: transparent;">.</span></p>
<p> </p>
<h3 dir="ltr" style="line-height: 1.38; margin-top: 8pt; margin-bottom: 0pt; text-align: justify;"><span style="font-size: 16px; font-family: 'Trebuchet MS'; color: #666666; vertical-align: baseline; background-color: transparent;">Simpler Logic and Less Code</span></h3>
<p> </p>
<p dir="ltr" style="line-height: 1.38; margin-top: 0pt; margin-bottom: 0pt; text-align: justify;"><span style="font-size: 15px; font-family: Arial; vertical-align: baseline; background-color: transparent;">With ZK-less region assignment, we simplified the region assignment logic. There are fewer concurrency problems. We now need less code when compared to ZooKeeper based region assignment, which makes the mechanism easier to understand and maintain. In release 2.0, the ZooKeeper based region assignment is completely removed. In patch </span><a href="https://issues.apache.org/jira/browse/HBASE-11611"><span style="font-size: 15px; font-family: Arial; color: #1155cc; text-decoration: underline; vertical-align: baseline; background-color: transparent;">HBASE-11611</span></a><span style="font-size: 15px; font-family: Arial; vertical-align: baseline; background-color: transparent;">, we deleted around 9000 lines of source code (SLOC) which is roughly 2% of the code in module hbase-client and hbase-server.</span></p>
<p> </p>
<h3 dir="ltr" style="line-height: 1.38; margin-top: 8pt; margin-bottom: 0pt; text-align: justify;"><span style="font-size: 16px; font-family: 'Trebuchet MS'; color: #666666; vertical-align: baseline; background-color: transparent;">Improvements</span></h3>
<p> </p>
<h5 dir="ltr" style="line-height: 1.38; margin-top: 8pt; margin-bottom: 0pt; text-align: justify;"><span style="font-size: 15px; font-family: 'Trebuchet MS'; color: #666666; font-weight: normal; vertical-align: baseline; background-color: transparent;">Scalability/performance</span></h5>
<p> </p>
<p dir="ltr" style="line-height: 1.38; margin-top: 0pt; margin-bottom: 0pt; text-align: justify;"><span style="font-size: 15px; font-family: Arial; vertical-align: baseline; background-color: transparent;">In patch HBASE-11059 ZK-less region assignment, we did some performance testing to show the time it takes to assign regions when a HBase cluster starts up. The following graph is from HBASE-11059:</span></p>
<p> </p>
<p dir="ltr" style="line-height: 1.38; margin-top: 0pt; margin-bottom: 0pt; text-align: center;"><span style="font-size: 15px; font-family: Arial; vertical-align: baseline; background-color: transparent;"><img src="https://lh4.googleusercontent.com/-FFYXkWZvL0EWkn_xnVfik8A-YLD6r82nORhAr-yfPuoI7Btjq32Zf6MPkbQkvwpB7B944ivO1PLqUbDanCd2mo_ghMUmaIYxsl1BOix_KqXVJr-mH8n7Bg_k3Q39hXxBvJoccg" width="424" height="250" style="transform: rotate(0rad); -webkit-transform: rotate(0rad);" /></span></p>
<p> </p>
<p dir="ltr" style="line-height: 1.38; margin-top: 0pt; margin-bottom: 0pt; text-align: justify;"><span style="font-size: 15px; font-family: Arial; vertical-align: baseline; background-color: transparent;">The blue line is for ZooKeeper based region assignment, and the green line for for ZK-less. It shows that it takes ZooKeeper based region assignment more time as the region number increases. For example, to assign 1 million regions, it took ZooKeeper based region assignment about 4100 seconds (68.3 minutes); ZK-less region assignment about 320 seconds (5.3 minutes).</span></p>
<p> </p>
<p dir="ltr" style="line-height: 1.38; margin-top: 0pt; margin-bottom: 0pt; text-align: justify;"><span style="font-size: 15px; font-family: Arial; vertical-align: baseline; background-color: transparent;">This shows that ZK-less region assignment can assign more regions in less time.</span></p>
<p> </p>
<h5 dir="ltr" style="line-height: 1.38; margin-top: 8pt; margin-bottom: 0pt; text-align: justify;"><span style="font-size: 15px; font-family: 'Trebuchet MS'; color: #666666; font-weight: normal; vertical-align: baseline; background-color: transparent;">Server rolling restart</span></h5>
<p> </p>
<p dir="ltr" style="line-height: 1.38; margin-top: 0pt; margin-bottom: 0pt; text-align: justify;"><span style="font-size: 15px; font-family: Arial; vertical-align: baseline; background-color: transparent;">The following graph shows the time to rolling restart a cluster. In this test, we have a small cluster with one master and 5 region servers. Load balancer is turned off. Here is what we do:</span></p>
<ol style="margin-top: 0pt; margin-bottom: 0pt;">
<li dir="ltr" style="list-style-type: decimal; font-size: 15px; font-family: Arial; vertical-align: baseline; background-color: transparent;">
<p dir="ltr" style="line-height: 1.38; margin-top: 0pt; margin-bottom: 0pt; text-align: justify;"><span style="vertical-align: baseline; background-color: transparent;">At first, we create a table with an expected number of regions;</span></p>
</li>
<li dir="ltr" style="list-style-type: decimal; font-size: 15px; font-family: Arial; vertical-align: baseline; background-color: transparent;">
<p dir="ltr" style="line-height: 1.38; margin-top: 0pt; margin-bottom: 0pt; text-align: justify;"><span style="vertical-align: baseline; background-color: transparent;">Load it with 1 million rows. We make sure the cluster is balanced;</span></p>
</li>
<li dir="ltr" style="list-style-type: decimal; font-size: 15px; font-family: Arial; vertical-align: baseline; background-color: transparent;">
<p dir="ltr" style="line-height: 1.38; margin-top: 0pt; margin-bottom: 0pt; text-align: justify;"><span style="vertical-align: baseline; background-color: transparent;">Move regions off one RegionServer to other RegionServers evenly;</span></p>
</li>
<li dir="ltr" style="list-style-type: decimal; font-size: 15px; font-family: Arial; vertical-align: baseline; background-color: transparent;">
<p dir="ltr" style="line-height: 1.38; margin-top: 0pt; margin-bottom: 0pt; text-align: justify;"><span style="vertical-align: baseline; background-color: transparent;">Restart the RegionServer;</span></p>
</li>
<li dir="ltr" style="list-style-type: decimal; font-size: 15px; font-family: Arial; vertical-align: baseline; background-color: transparent;">
<p dir="ltr" style="line-height: 1.38; margin-top: 0pt; margin-bottom: 0pt; text-align: justify;"><span style="vertical-align: baseline; background-color: transparent;">Move the same set of regions back;</span></p>
</li>
<li dir="ltr" style="list-style-type: decimal; font-size: 15px; font-family: Arial; vertical-align: baseline; background-color: transparent;">
<p dir="ltr" style="line-height: 1.38; margin-top: 0pt; margin-bottom: 0pt; text-align: justify;"><span style="vertical-align: baseline; background-color: transparent;">Do the same for all RegionServers;</span></p>
</li>
<li dir="ltr" style="list-style-type: decimal; font-size: 15px; font-family: Arial; vertical-align: baseline; background-color: transparent;">
<p dir="ltr" style="line-height: 1.38; margin-top: 0pt; margin-bottom: 0pt; text-align: justify;"><span style="vertical-align: baseline; background-color: transparent;">Do the same for Master.</span></p>
</li>
</ol>
<p> </p>
<p dir="ltr" style="line-height: 1.38; margin-top: 0pt; margin-bottom: 0pt; text-align: justify;"><span style="font-size: 15px; font-family: Arial; vertical-align: baseline; background-color: transparent;">We measure the time from Step 3 to 7, i.e. the total time to rolling restart the whole cluster. The result shows it takes less time with ZK-less based region assignment to rolling restart a HBase cluster.</span></p>
<p> </p>
<p dir="ltr" style="line-height: 1.38; margin-top: 0pt; margin-bottom: 0pt; text-align: center;"><span style="font-size: 15px; font-family: Arial; vertical-align: baseline; background-color: transparent;"><img src="https://lh3.googleusercontent.com/obS_6jTlnDGJYao0OQKTJ465igbfYA83RIN9BS11-L4kKbefKiDbkg-Ow6d20oI3xQnf-cpjLpnRSSJU67GR3CgsSwj_lF1VyzwAIAR-NJYUGGjK9q4FKMq3WBgAoNeGky4wJWM" width="459" height="275" style="transform: rotate(0rad); -webkit-transform: rotate(0rad);" /></span></p>
<p> </p>
<h5 dir="ltr" style="line-height: 1.38; margin-top: 8pt; margin-bottom: 0pt; text-align: justify;"><span style="font-size: 15px; font-family: 'Trebuchet MS'; color: #666666; font-weight: normal; vertical-align: baseline; background-color: transparent;">Server recovery</span></h5>
<p> </p>
<p dir="ltr" style="line-height: 1.38; margin-top: 0pt; margin-bottom: 0pt;"><span style="font-size: 15px; font-family: Arial; vertical-align: baseline; background-color: transparent;">Any node in a cluster could crash. We did some testing to find out how soon a region will be available after a node dies. During this testing, we have a cluster with 1 master, 1 backup master, 3 region servers, and 3000 user regions. We used ycsb to measure the maximum latency while some node is killed and the cluster is recovered. The other measurements like average latency is not used since it&rsquo;s uncertain if ycsb tries to access to the same regions at each test, or if the same regions are impacted while a node is killed. </span></p>
<p> </p>
<p dir="ltr" style="line-height: 1.38; margin-top: 0pt; margin-bottom: 0pt; text-align: justify;"><span style="font-size: 15px; font-family: Arial; vertical-align: baseline; background-color: transparent;">With the ZK-less assignment and meta co-located with Master, here is what we got:</span></p>
<div dir="ltr" style="margin-left: 0pt;">
<table style="border: none; border-collapse: collapse;">
<colgroup>
<col width="345" />
<col width="278" /></colgroup>
<tbody>
<tr style="height: 0px;">
<td style="border: 1px solid #000000; vertical-align: top; padding: 7px;">
<p dir="ltr" style="line-height: 1.2; margin-top: 0pt; margin-bottom: 0pt; text-align: justify;"><span style="font-size: 15px; font-family: 'Trebuchet MS'; color: #666666; vertical-align: baseline; background-color: transparent;">Test - the node killed</span></p>
</td>
<td style="border: 1px solid #000000; vertical-align: top; padding: 7px;">
<p dir="ltr" style="line-height: 1.2; margin-top: 0pt; margin-bottom: 0pt; text-align: justify;"><span style="font-size: 15px; font-family: 'Trebuchet MS'; color: #666666; vertical-align: baseline; background-color: transparent;">Maximum latency (s)</span></p>
</td>
</tr>
<tr style="height: 0px;">
<td style="border: 1px solid #000000; vertical-align: top; padding: 7px;">
<p dir="ltr" style="line-height: 1.2; margin-top: 0pt; margin-bottom: 0pt; text-align: justify;"><span style="font-size: 15px; font-family: 'Trebuchet MS'; color: #666666; vertical-align: baseline; background-color: transparent;">Master</span></p>
</td>
<td style="border: 1px solid #000000; vertical-align: top; padding: 7px;">
<p dir="ltr" style="line-height: 1.2; margin-top: 0pt; margin-bottom: 0pt; text-align: justify;"><span style="font-size: 15px; font-family: 'Trebuchet MS'; color: #666666; vertical-align: baseline; background-color: transparent;">51.88</span></p>
</td>
</tr>
<tr style="height: 0px;">
<td style="border: 1px solid #000000; vertical-align: top; padding: 7px;">
<p dir="ltr" style="line-height: 1.2; margin-top: 0pt; margin-bottom: 0pt; text-align: justify;"><span style="font-size: 15px; font-family: 'Trebuchet MS'; color: #666666; vertical-align: baseline; background-color: transparent;">Region server</span></p>
</td>
<td style="border: 1px solid #000000; vertical-align: top; padding: 7px;">
<p dir="ltr" style="line-height: 1.2; margin-top: 0pt; margin-bottom: 0pt; text-align: justify;"><span style="font-size: 15px; font-family: 'Trebuchet MS'; color: #666666; vertical-align: baseline; background-color: transparent;">48.33</span></p>
</td>
</tr>
<tr style="height: 0px;">
<td style="border: 1px solid #000000; vertical-align: top; padding: 7px;">
<p dir="ltr" style="line-height: 1.2; margin-top: 0pt; margin-bottom: 0pt; text-align: justify;"><span style="font-size: 15px; font-family: 'Trebuchet MS'; color: #666666; vertical-align: baseline; background-color: transparent;">Master + region server</span></p>
</td>
<td style="border: 1px solid #000000; vertical-align: top; padding: 7px;">
<p dir="ltr" style="line-height: 1.2; margin-top: 0pt; margin-bottom: 0pt; text-align: justify;"><span style="font-size: 15px; font-family: 'Trebuchet MS'; color: #666666; vertical-align: baseline; background-color: transparent;">68.57</span></p>
</td>
</tr>
</tbody>
</table></div>
<p> </p>
<p dir="ltr" style="line-height: 1.38; margin-top: 0pt; margin-bottom: 0pt; text-align: justify;"><span style="font-size: 15px; font-family: Arial; vertical-align: baseline; background-color: transparent;">With ZK based region assignment and meta not co-located with Master, here is what we got:</span></p>
<p> </p>
<div dir="ltr" style="margin-left: 0pt;">
<table style="border: none; border-collapse: collapse;">
<colgroup>
<col width="345" />
<col width="278" /></colgroup>
<tbody>
<tr style="height: 0px;">
<td style="border: 1px solid #000000; vertical-align: top; padding: 7px;">
<p dir="ltr" style="line-height: 1.2; margin-top: 0pt; margin-bottom: 0pt; text-align: justify;"><span style="font-size: 15px; font-family: 'Trebuchet MS'; color: #666666; vertical-align: baseline; background-color: transparent;">Test - the node killed</span></p>
</td>
<td style="border: 1px solid #000000; vertical-align: top; padding: 7px;">
<p dir="ltr" style="line-height: 1.2; margin-top: 0pt; margin-bottom: 0pt; text-align: justify;"><span style="font-size: 15px; font-family: 'Trebuchet MS'; color: #666666; vertical-align: baseline; background-color: transparent;">Maximum latency (s)</span></p>
</td>
</tr>
<tr style="height: 0px;">
<td style="border: 1px solid #000000; vertical-align: top; padding: 7px;">
<p dir="ltr" style="line-height: 1.2; margin-top: 0pt; margin-bottom: 0pt; text-align: justify;"><span style="font-size: 15px; font-family: 'Trebuchet MS'; color: #666666; vertical-align: baseline; background-color: transparent;">Master</span></p>
</td>
<td style="border: 1px solid #000000; vertical-align: top; padding: 7px;">
<p dir="ltr" style="line-height: 1.2; margin-top: 0pt; margin-bottom: 0pt; text-align: justify;"><span style="font-size: 15px; font-family: 'Trebuchet MS'; color: #666666; vertical-align: baseline; background-color: transparent;">1.93</span></p>
</td>
</tr>
<tr style="height: 0px;">
<td style="border: 1px solid #000000; vertical-align: top; padding: 7px;">
<p dir="ltr" style="line-height: 1.2; margin-top: 0pt; margin-bottom: 0pt; text-align: justify;"><span style="font-size: 15px; font-family: 'Trebuchet MS'; color: #666666; vertical-align: baseline; background-color: transparent;">Region server with no meta</span></p>
</td>
<td style="border: 1px solid #000000; vertical-align: top; padding: 7px;">
<p dir="ltr" style="line-height: 1.2; margin-top: 0pt; margin-bottom: 0pt; text-align: justify;"><span style="font-size: 15px; font-family: 'Trebuchet MS'; color: #666666; vertical-align: baseline; background-color: transparent;">49.41</span></p>
</td>
</tr>
<tr style="height: 0px;">
<td style="border: 1px solid #000000; vertical-align: top; padding: 7px;">
<p dir="ltr" style="line-height: 1.2; margin-top: 0pt; margin-bottom: 0pt; text-align: justify;"><span style="font-size: 15px; font-family: 'Trebuchet MS'; color: #666666; vertical-align: baseline; background-color: transparent;">Region server with meta</span></p>
</td>
<td style="border: 1px solid #000000; vertical-align: top; padding: 7px;">
<p dir="ltr" style="line-height: 1.2; margin-top: 0pt; margin-bottom: 0pt; text-align: justify;"><span style="font-size: 15px; font-family: 'Trebuchet MS'; color: #666666; vertical-align: baseline; background-color: transparent;">56.46</span></p>
</td>
</tr>
<tr style="height: 0px;">
<td style="border: 1px solid #000000; vertical-align: top; padding: 7px;">
<p dir="ltr" style="line-height: 1.2; margin-top: 0pt; margin-bottom: 0pt; text-align: justify;"><span style="font-size: 15px; font-family: 'Trebuchet MS'; color: #666666; vertical-align: baseline; background-color: transparent;">Master + region server with meta</span></p>
</td>
<td style="border: 1px solid #000000; vertical-align: top; padding: 7px;">
<p dir="ltr" style="line-height: 1.2; margin-top: 0pt; margin-bottom: 0pt; text-align: justify;"><span style="font-size: 15px; font-family: 'Trebuchet MS'; color: #666666; vertical-align: baseline; background-color: transparent;">86.55</span></p>
</td>
</tr>
</tbody>
</table></div>
<p> </p>
<p dir="ltr" style="line-height: 1.38; margin-top: 0pt; margin-bottom: 0pt; text-align: justify;"><span style="font-size: 15px; font-family: Arial; vertical-align: baseline; background-color: transparent;">In ZK-less region assignment, the Master hosts the meta region. So killing the master in the new scheme, the impact is much bigger than killing the master in the old scheme.</span></p>
<p> </p>
<h5 dir="ltr" style="line-height: 1.38; margin-top: 8pt; margin-bottom: 0pt; text-align: justify;"><span style="font-size: 15px; font-family: 'Trebuchet MS'; color: #666666; font-weight: normal; vertical-align: baseline; background-color: transparent;">Reliability</span></h5>
<p> </p>
<p dir="ltr" style="line-height: 1.38; margin-top: 0pt; margin-bottom: 0pt; text-align: justify;"><span style="font-size: 15px; font-family: Arial; vertical-align: baseline; background-color: transparent;">As we mentioned above, generally, release 0.96 is considered to be much more stable when compared to previous releases. By the same standard, ZK-less region assignment is stable too. </span><a href="https://issues.apache.org/jira/browse/HBASE-8031"><span style="font-size: 15px; font-family: Arial; color: #1155cc; text-decoration: underline; vertical-align: baseline; background-color: transparent;">IntegrationTestBigLinkedList</span></a><span style="font-size: 15px; font-family: Arial; vertical-align: baseline; background-color: transparent;"> with chaos monkey is always green for us.</span></p>
<p> </p>
<h3 dir="ltr" style="line-height: 1.38; margin-top: 8pt; margin-bottom: 0pt; text-align: justify;"><span style="font-size: 16px; font-family: 'Trebuchet MS'; color: #666666; vertical-align: baseline; background-color: transparent;">Co-locating Meta and Master</span></h3>
<p> </p>
<p dir="ltr" style="line-height: 1.38; margin-top: 0pt; margin-bottom: 0pt; text-align: justify;"><span style="font-size: 15px; font-family: Arial; vertical-align: baseline; background-color: transparent;">For ZK-less region assignment, currently we need meta to be co-located with master. Master needs meta to be available all the time. During region transition, we always persist region states in meta. If meta is not available, no region transition can happen since we can&rsquo;t update meta. Currently, we will keep trying to update meta in such a case, while the lock to the region states object is held (the lock is to ensure the states in memory is consistent). This leads to a deadlock. That&rsquo;s why it&rsquo;s required that meta to be co-located with Master currently.</span></p>
<p> </p>
<p dir="ltr" style="line-height: 1.38; margin-top: 0pt; margin-bottom: 0pt; text-align: justify;"><span style="font-size: 15px; font-family: Arial; vertical-align: baseline; background-color: transparent;">Actually, it is good to have meta on master for reasons like performance, simplicity, etc. If meta is on Master, Master can access meta through short-circuit, bypass network and RPC layers. This is good for performance. Whenever a Master starts up, it assigns meta to itself. So Master can assume meta is always available, which makes things simpler.</span></p>
<p> </p>
<p dir="ltr" style="line-height: 1.38; margin-top: 0pt; margin-bottom: 0pt; text-align: justify;"><span style="font-size: 15px; font-family: Arial; vertical-align: baseline; background-color: transparent;">With co-location, if a Master fails over, the meta is always needed to recover and re-assign. This is very different from before. This puts the Master in the critical path since applications need to access the meta to find the locations of user regions if not already cached by the applications.</span></p>
<p> </p>
<h3 dir="ltr" style="line-height: 1.38; margin-top: 0pt; margin-bottom: 0pt; text-align: justify;"><span style="font-size: 15px; font-family: Arial; font-weight: normal; vertical-align: baseline; background-color: transparent;">If you have millions of regions or less, one meta region is enough. It is an improvement over current scalability for ZK-less region assignment with the co-location restriction. Further region scalability improvements will require splitting meta, while region state transitions are still persisted. This is future work.</span></h3>
<p> </p>
<h3 dir="ltr" style="line-height: 1.38; margin-top: 8pt; margin-bottom: 0pt; text-align: justify;"><span style="font-size: 16px; font-family: 'Trebuchet MS'; color: #666666; vertical-align: baseline; background-color: transparent;">Summary</span></h3>
<p> </p>
<p dir="ltr" style="line-height: 1.38; margin-top: 0pt; margin-bottom: 0pt; text-align: justify;"><span style="font-size: 15px; font-family: Arial; vertical-align: baseline; background-color: transparent;">RPC based region assignment currently requires the meta region to be assigned on the Master (there are discussions to eliminate such a limitation). Compared to ZooKeeper based region assignment, RPC based region assignment is simpler and has better performance, however, currently it needs meta to be co-located with the Master.</span></p>
