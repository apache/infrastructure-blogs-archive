<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1"><!-- Begin Jekyll SEO tag v2.8.0 -->
<title>The Little Things(1): Do Not Delete | Blogs Archive</title>
<meta name="generator" content="Jekyll v3.9.3" />
<meta property="og:title" content="The Little Things(1): Do Not Delete" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="CouchDB takes data storage extremely seriously. This usually means we work hard to make sure that the CouchDB storage modules are as robust as we can make them. Sometimes though, we go all the way to the HTTP API to secure against accidental data loss, saving users from their mistakes, rather than dealing with hard drives and kernel caches that usually stand in the way of safe data storage. The scenario: To delete a document in CouchDB, you issue the following HTTP request: DELETE /database/docid?rev=12345 HTTP/1.1 &lt;/code&gt; A common way to program this looks like this: http.request(&#39;DELETE&#39;, db + &#39;/&#39; + docId + &#39;?rev=&#39; + docRev); &lt;/code&gt; So far so innocent. Sometimes though, users came to us and complained that their whole database was deleted by that code. Turns out the above code creates a request that deletes the whole database, if the docId variable isn&rsquo;t set correctly. The request then looks like: DELETE /database/?rev=12345 HTTP/1.1 &lt;/code&gt; It looks like an honest mistake, once you check the CouchDB log file, but good old CouchDB would just go ahead and delete the database, ignoring the ?rev= value. We thought this is a good opportunity to help users not accidentally losing their data. So since late 2009 (yes, this is an oldie, but it came up in a recent discussion and we thought it is worth writing about :), CouchDB will not delete a database, if it sees that a ?rev= parameter is present and it looks like that this is just a malformed request, as database deletions have no business requiring a ?rev=. One can make an easy argument that the code sample is fairly shoddy and we&rsquo;d agree. But we are not here to argue how our users use our database beyond complying with the API and recommended use-cases. And if we can help them keep their data, that&rsquo;s a win in our book Continuing down this thought, we thought we could do one better. You know that to delete a document, you must pass the current rev value, like you see above. This is to ensure that we don&rsquo;t delete the document accidentally without knowing that someone else may have added an update to it that we don&rsquo;t actually want to delete. It&rsquo;s CouchDB&rsquo;s standard multi version currency control (MVCC) mechanism at work. Databases don&rsquo;t have revisions like documents, and deleting a database is a simple HTTP DELETE /database away. Databases, however, do have a sequence id, it&rsquo;s the ID you get from the changes feed, it&rsquo;s an number that starts at 0 when the database is created and increments by 1 each time a document is added, updated or deleted. Each state of the database has a single sequence ID associated with it. Similar to a rev, we could require the latest sequence ID to delete a database, as in: DELETE /database?seq_id=6789 &lt;/code&gt; And deny database deletes that don&rsquo;t carry the latest seq_id. We think this is a decent idea, but unfortunately, this would break backwards compatibility with older versions of CouchDB and it would break a good amount of code in the field, so we are hesitant to add this feature. In addition, sequence IDs change a little when BigCouch finally gets merged, so we&rsquo;d have to look at this again then. In the meantime, we have the protection against simple coding errors and we are happy that our users keep their hard earned data more often now." />
<meta property="og:description" content="CouchDB takes data storage extremely seriously. This usually means we work hard to make sure that the CouchDB storage modules are as robust as we can make them. Sometimes though, we go all the way to the HTTP API to secure against accidental data loss, saving users from their mistakes, rather than dealing with hard drives and kernel caches that usually stand in the way of safe data storage. The scenario: To delete a document in CouchDB, you issue the following HTTP request: DELETE /database/docid?rev=12345 HTTP/1.1 &lt;/code&gt; A common way to program this looks like this: http.request(&#39;DELETE&#39;, db + &#39;/&#39; + docId + &#39;?rev=&#39; + docRev); &lt;/code&gt; So far so innocent. Sometimes though, users came to us and complained that their whole database was deleted by that code. Turns out the above code creates a request that deletes the whole database, if the docId variable isn&rsquo;t set correctly. The request then looks like: DELETE /database/?rev=12345 HTTP/1.1 &lt;/code&gt; It looks like an honest mistake, once you check the CouchDB log file, but good old CouchDB would just go ahead and delete the database, ignoring the ?rev= value. We thought this is a good opportunity to help users not accidentally losing their data. So since late 2009 (yes, this is an oldie, but it came up in a recent discussion and we thought it is worth writing about :), CouchDB will not delete a database, if it sees that a ?rev= parameter is present and it looks like that this is just a malformed request, as database deletions have no business requiring a ?rev=. One can make an easy argument that the code sample is fairly shoddy and we&rsquo;d agree. But we are not here to argue how our users use our database beyond complying with the API and recommended use-cases. And if we can help them keep their data, that&rsquo;s a win in our book Continuing down this thought, we thought we could do one better. You know that to delete a document, you must pass the current rev value, like you see above. This is to ensure that we don&rsquo;t delete the document accidentally without knowing that someone else may have added an update to it that we don&rsquo;t actually want to delete. It&rsquo;s CouchDB&rsquo;s standard multi version currency control (MVCC) mechanism at work. Databases don&rsquo;t have revisions like documents, and deleting a database is a simple HTTP DELETE /database away. Databases, however, do have a sequence id, it&rsquo;s the ID you get from the changes feed, it&rsquo;s an number that starts at 0 when the database is created and increments by 1 each time a document is added, updated or deleted. Each state of the database has a single sequence ID associated with it. Similar to a rev, we could require the latest sequence ID to delete a database, as in: DELETE /database?seq_id=6789 &lt;/code&gt; And deny database deletes that don&rsquo;t carry the latest seq_id. We think this is a decent idea, but unfortunately, this would break backwards compatibility with older versions of CouchDB and it would break a good amount of code in the field, so we are hesitant to add this feature. In addition, sequence IDs change a little when BigCouch finally gets merged, so we&rsquo;d have to look at this again then. In the meantime, we have the protection against simple coding errors and we are happy that our users keep their hard earned data more often now." />
<link rel="canonical" href="http://localhost:4000/couchdb/entry/the_little_things_1_do" />
<meta property="og:url" content="http://localhost:4000/couchdb/entry/the_little_things_1_do" />
<meta property="og:site_name" content="Blogs Archive" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2014-04-08T13:59:12-04:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="The Little Things(1): Do Not Delete" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2014-04-08T13:59:12-04:00","datePublished":"2014-04-08T13:59:12-04:00","description":"CouchDB takes data storage extremely seriously. This usually means we work hard to make sure that the CouchDB storage modules are as robust as we can make them. Sometimes though, we go all the way to the HTTP API to secure against accidental data loss, saving users from their mistakes, rather than dealing with hard drives and kernel caches that usually stand in the way of safe data storage. The scenario: To delete a document in CouchDB, you issue the following HTTP request: DELETE /database/docid?rev=12345 HTTP/1.1 &lt;/code&gt; A common way to program this looks like this: http.request(&#39;DELETE&#39;, db + &#39;/&#39; + docId + &#39;?rev=&#39; + docRev); &lt;/code&gt; So far so innocent. Sometimes though, users came to us and complained that their whole database was deleted by that code. Turns out the above code creates a request that deletes the whole database, if the docId variable isn&rsquo;t set correctly. The request then looks like: DELETE /database/?rev=12345 HTTP/1.1 &lt;/code&gt; It looks like an honest mistake, once you check the CouchDB log file, but good old CouchDB would just go ahead and delete the database, ignoring the ?rev= value. We thought this is a good opportunity to help users not accidentally losing their data. So since late 2009 (yes, this is an oldie, but it came up in a recent discussion and we thought it is worth writing about :), CouchDB will not delete a database, if it sees that a ?rev= parameter is present and it looks like that this is just a malformed request, as database deletions have no business requiring a ?rev=. One can make an easy argument that the code sample is fairly shoddy and we&rsquo;d agree. But we are not here to argue how our users use our database beyond complying with the API and recommended use-cases. And if we can help them keep their data, that&rsquo;s a win in our book Continuing down this thought, we thought we could do one better. You know that to delete a document, you must pass the current rev value, like you see above. This is to ensure that we don&rsquo;t delete the document accidentally without knowing that someone else may have added an update to it that we don&rsquo;t actually want to delete. It&rsquo;s CouchDB&rsquo;s standard multi version currency control (MVCC) mechanism at work. Databases don&rsquo;t have revisions like documents, and deleting a database is a simple HTTP DELETE /database away. Databases, however, do have a sequence id, it&rsquo;s the ID you get from the changes feed, it&rsquo;s an number that starts at 0 when the database is created and increments by 1 each time a document is added, updated or deleted. Each state of the database has a single sequence ID associated with it. Similar to a rev, we could require the latest sequence ID to delete a database, as in: DELETE /database?seq_id=6789 &lt;/code&gt; And deny database deletes that don&rsquo;t carry the latest seq_id. We think this is a decent idea, but unfortunately, this would break backwards compatibility with older versions of CouchDB and it would break a good amount of code in the field, so we are hesitant to add this feature. In addition, sequence IDs change a little when BigCouch finally gets merged, so we&rsquo;d have to look at this again then. In the meantime, we have the protection against simple coding errors and we are happy that our users keep their hard earned data more often now.","headline":"The Little Things(1): Do Not Delete","mainEntityOfPage":{"@type":"WebPage","@id":"http://localhost:4000/couchdb/entry/the_little_things_1_do"},"url":"http://localhost:4000/couchdb/entry/the_little_things_1_do"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/assets/main.css"><link type="application/atom+xml" rel="alternate" href="http://localhost:4000/feed.xml" title="Blogs Archive" /></head>
<body><header class="site-header" role="banner">

  <div class="wrapper"><a class="site-title" rel="author" href="/">Blogs Archive</a><nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger"><a class="page-link" href="/about/">About</a></div>
      </nav></div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">The Little Things(1): Do Not Delete</h1>
    <p class="post-meta">
      <time class="dt-published" datetime="2014-04-08T13:59:12-04:00" itemprop="datePublished">Apr 8, 2014
      </time>• <span itemprop="author" itemscope itemtype="http://schema.org/Person"><span class="p-author h-card" itemprop="name">{"display_name"=>"Jan", "login"=>"jan", "email"=>"jan@apache.org"}</span></span></p>
  </header>

  <div class="post-content e-content" itemprop="articleBody">
    <p>CouchDB takes data storage extremely seriously. This usually means we work hard to make sure that the CouchDB storage modules are as robust as we can make them. Sometimes though, we go all the way to the HTTP API to secure against accidental data loss, saving users from their mistakes, rather than dealing with hard drives and kernel caches that usually stand in the way of safe data storage.</p>
<h2>The scenario:</h2>
<p>To delete a document in CouchDB, you issue the following HTTP request:</p>
<p><code>
<pre>DELETE /database/docid?rev=12345 HTTP/1.1</pre>
<p></code></p>
<p>A common way to program this looks like this:</p>
<p><code>
<pre>http.request('DELETE', db + '/' + docId + '?rev=' + docRev);</pre>
<p></code></p>
<p>So far so innocent. Sometimes though, users came to us and complained that their whole database was deleted by that code.</p>
<p>Turns out the above code creates a request that deletes the whole database, if the docId variable isn&rsquo;t set correctly. The request then looks like:</p>
<p><code>
<pre>DELETE /database/?rev=12345 HTTP/1.1</pre>
<p></code></p>
<p>It looks like an honest mistake, once you check the CouchDB log file, but good old CouchDB would just go ahead and delete the database, ignoring the <code>?rev=</code> value.</p>
<p>We thought this is a good opportunity to help users not accidentally losing their data. So since late 2009 (yes, this is an oldie, but it came up in a recent discussion and we thought it is worth writing about :), CouchDB will not delete a database, if it sees that a <code>?rev=</code> parameter is present and it looks like that this is just a malformed request, as database deletions have no business requiring a <code>?rev=</code>.</p>
<p>One can make an easy argument that the code sample is fairly shoddy and we&rsquo;d agree. But we are not here to argue how our users use our database beyond complying with the API and recommended use-cases. And if we can help them keep their data, that&rsquo;s a win in our book</p>
<p>Continuing down this thought, we thought we could do one better. You know that to delete a document, you must pass the current rev value, like you see above. This is to ensure that we don&rsquo;t delete the document accidentally without knowing that someone else may have added an update to it that we don&rsquo;t actually want to delete. It&rsquo;s CouchDB&rsquo;s standard multi version currency control (MVCC) mechanism at work.</p>
<p>Databases don&rsquo;t have revisions like documents, and deleting a database is a simple <code>HTTP DELETE /database</code> away. Databases, however, do have a sequence id, it&rsquo;s the ID you get from the changes feed, it&rsquo;s an number that starts at 0 when the database is created and increments by 1 each time a document is added, updated or deleted. Each state of the database has a single sequence ID associated with it.</p>
<p>Similar to a rev, we could require the latest sequence ID to delete a database, as in:</p>
<p><code>
<pre>DELETE /database?seq_id=6789</pre>
<p></code></p>
<p>And deny database deletes that don&rsquo;t carry the latest <code>seq_id</code>. We think this is a decent idea, but unfortunately, this would break backwards compatibility with older versions of CouchDB and it would break a good amount of code in the field, so we are hesitant to add this feature. In addition, sequence IDs change a little when BigCouch finally gets merged, so we&rsquo;d have to look at this again then.</p>
<p>In the meantime, we have the protection against simple coding errors and we are happy that our users keep their hard earned data more often now.</p>

  </div><a class="u-url" href="/couchdb/entry/the_little_things_1_do" hidden></a>
</article>

      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/"></data>

  <div class="wrapper">

    <h2 class="footer-heading">Blogs Archive</h2>

    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <ul class="contact-list">
          <li class="p-name">Blogs Archive</li><li><a class="u-email" href="mailto:issues@infra.apache.org">issues@infra.apache.org</a></li></ul>
      </div>

      <div class="footer-col footer-col-2"><ul class="social-media-list"><li><a href="https://github.com/jekyll"><svg class="svg-icon"><use xlink:href="/assets/minima-social-icons.svg#github"></use></svg> <span class="username">jekyll</span></a></li><li><a href="https://www.twitter.com/jekyllrb"><svg class="svg-icon"><use xlink:href="/assets/minima-social-icons.svg#twitter"></use></svg> <span class="username">jekyllrb</span></a></li></ul>
</div>

      <div class="footer-col footer-col-3">
        <p>This is an archive of the Roller blogs that were previously hosted on blogs.apache.org</p>
      </div>
    </div>

  </div>

</footer>
</body>

</html>
