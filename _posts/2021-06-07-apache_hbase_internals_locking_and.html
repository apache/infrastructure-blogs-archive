---
layout: post
status: PUBLISHED
published: true
title: 'Apache HBase Internals: Locking and Multiversion Concurrency Control'
author:
  display_name: Michael Stack
  login: stack
  email: stack@apache.org
author_login: stack
author_email: stack@apache.org
id: 6595f0ef-8786-4c81-9722-f358ed1d8ffc
date: '2021-06-07 16:48:27 -0400'
categories:
- General
tags:
- hbase
- locking
- mvcc
comments: []
permalink: hbase/entry/apache_hbase_internals_locking_and
---
<p>by Gregory Chanan</p>
<p>HBase Committer</p>
<p>Cloudera, Inc.&nbsp;</p>
<p><b id="internal-source-marker_0.08475310145877302" style="font-family: Times; font-size: medium; font-weight: normal;"> </p>
<p><b id="internal-source-marker_0.08475310145877302" style="font-weight: normal;"> </b></p>
<p><b id="internal-source-marker_0.08475310145877302" style="font-weight: normal;"> </b></p></p>
<p><b id="internal-source-marker_0.08475310145877302" style="font-weight: normal;"> </b></p>
<p><b id="internal-source-marker_0.08475310145877302" style="font-weight: normal;"> </b></p></p>
<p><span style="font-size: 16px; font-family: Arial; background-color: transparent; vertical-align: baseline; white-space: pre-wrap;">NOTE: This blog post describes how Apache HBase does concurrency control. &nbsp;This assumes knowledge of the HBase write path, which you can read more about in this other </span><a href="http://blog.cloudera.com/blog/2012/06/hbase-write-path/"><span style="font-size: 16px; font-family: Arial; color: #1155cc; background-color: transparent; text-decoration: underline; vertical-align: baseline; white-space: pre-wrap;">blog post</span></a><span style="font-size: 16px; font-family: Arial; background-color: transparent; vertical-align: baseline; white-space: pre-wrap;">.</span><br></p>
<h2><span style="font-size: 16px; font-family: Arial; background-color: transparent; vertical-align: baseline; white-space: pre-wrap;">Introduction</span></h2>
<p><span style="font-size: 16px; font-family: Arial; background-color: transparent; vertical-align: baseline; white-space: pre-wrap;">Apache HBase provides a consistent and understandable data model to the user while still offering high performance. &nbsp;In this blog, we&rsquo;ll first discuss the guarantees of the HBase data model and how they differ from those of a traditional database. &nbsp;Next, we&rsquo;ll motivate the need for concurrency control by studying concurrent writes and then introduce a simple concurrency control solution. &nbsp;Finally, we&rsquo;ll study read/write concurrency control and discuss an efficient solution called Multiversion Concurrency Control.</span><br> </p>
<h2><span style="font-size: 16px; font-family: Arial; background-color: transparent; vertical-align: baseline; white-space: pre-wrap;">Why Concurrency Control?</span></h2>
<p><span style="font-size: 16px; font-family: Arial; background-color: transparent; vertical-align: baseline; white-space: pre-wrap;">In order to understand HBase concurrency control, we first need to understand why HBase needs concurrency control at all; in other words, what properties does HBase guarantee about the data that requires concurrency control?</span><br><span style="font-size: 16px; font-family: Arial; background-color: transparent; vertical-align: baseline; white-space: pre-wrap;"></span><br><span style="font-size: 16px; font-family: Arial; background-color: transparent; vertical-align: baseline; white-space: pre-wrap;">The answer is that HBase guarantees </span><a href="http://hbase.apache.org/acid-semantics.html"><span style="font-size: 16px; font-family: Arial; color: #1155cc; background-color: transparent; text-decoration: underline; vertical-align: baseline; white-space: pre-wrap;">ACID semantics per-row</span></a><span style="font-size: 16px; font-family: Arial; background-color: transparent; vertical-align: baseline; white-space: pre-wrap;">. &nbsp;ACID is an acronym for:</span><br><span style="font-size: 16px; font-family: Arial; background-color: transparent; vertical-align: baseline; white-space: pre-wrap;">&bull; Atomicity: All parts of transaction complete or none complete</span><br><span style="font-size: 16px; font-family: Arial; background-color: transparent; vertical-align: baseline; white-space: pre-wrap;">&bull; Consistency: Only valid data written to database</span><br><span style="font-size: 16px; font-family: Arial; background-color: transparent; vertical-align: baseline; white-space: pre-wrap;">&bull; Isolation: Parallel transactions do not impact each other&rsquo;s execution</span><br><span style="font-size: 16px; font-family: Arial; background-color: transparent; vertical-align: baseline; white-space: pre-wrap;">&bull; Durability: Once transaction committed, it remains</span><br><span style="font-size: 16px; font-family: Arial; background-color: transparent; vertical-align: baseline; white-space: pre-wrap;"></span><br><span style="font-size: 16px; font-family: Arial; background-color: transparent; vertical-align: baseline; white-space: pre-wrap;">If you have experience with traditional relational databases, these terms may be familiar to you. &nbsp;Traditional relational databases typically provide ACID semantics across all the data in the database; for performance reasons, HBase only provides ACID semantics on a per-row basis. &nbsp;If you are not familiar with these terms, don&rsquo;t worry. &nbsp;Instead of dwelling on the precise definitions, let&rsquo;s look at a couple of examples.</span><br> </p>
<h2><span style="font-size: 16px; font-family: Arial; background-color: transparent; vertical-align: baseline; white-space: pre-wrap;">Writes and Write-Write Synchronization</span></h2>
<p><span style="font-size: 16px; font-family: Arial; background-color: transparent; vertical-align: baseline; white-space: pre-wrap;">Consider two concurrent writes to HBase that represent {company, role} combinations I&rsquo;ve held:</span></p>
<p></b>
<p><b id="internal-source-marker_0.08475310145877302" style="font-family: Times; font-size: medium; font-weight: normal;"><span style="font-size: 16px; font-family: Arial; background-color: transparent; vertical-align: baseline; white-space: pre-wrap;"></span><img src="https://blogs.apache.org/hbase/mediaresource/12b2c8a4-551b-4aa5-8629-874e220a91bd" width="367" height="49"></b></p>
<p><b id="internal-source-marker_0.08475310145877302" style="font-family: Times; font-size: medium; font-weight: normal;"><img src="https://blogs.apache.org/hbase/mediaresource/43338c9b-78c7-4b54-a031-17d18e1695cc" width="366" height="52"><span style="font-size: 16px; font-family: Arial; background-color: transparent; vertical-align: baseline; white-space: pre-wrap;"></span><br><span style="font-size: 16px; font-family: Arial; background-color: transparent; font-style: italic; vertical-align: baseline; white-space: pre-wrap;">Image 1. &nbsp;Two writes to the same row</span><br><span style="font-size: 16px; font-family: Arial; background-color: transparent; vertical-align: baseline; white-space: pre-wrap;"></span><br><span style="font-size: 16px; font-family: Arial; background-color: transparent; vertical-align: baseline; white-space: pre-wrap;">From the previously cited </span><a href="http://blog.cloudera.com/blog/2012/06/hbase-write-path/"><span style="font-size: 16px; font-family: Arial; color: #1155cc; background-color: transparent; text-decoration: underline; vertical-align: baseline; white-space: pre-wrap;">Write Path Blog Post</span></a><span style="font-size: 16px; font-family: Arial; background-color: transparent; vertical-align: baseline; white-space: pre-wrap;">, we know that HBase will perform the following steps for each write:</span><br><span style="font-size: 16px; font-family: Arial; background-color: transparent; vertical-align: baseline; white-space: pre-wrap;"></span><br><span style="font-size: 16px; font-family: Arial; background-color: transparent; vertical-align: baseline; white-space: pre-wrap;">(1) Write to Write-Ahead-Log (WAL)</span><br><span style="font-size: 16px; font-family: Arial; background-color: transparent; vertical-align: baseline; white-space: pre-wrap;">(2) Update MemStore: write each data cell [the (row, column) pair] to the memstore</span><br><span style="font-size: 16px; font-family: Arial; background-color: transparent; font-style: italic; vertical-align: baseline; white-space: pre-wrap;">List 1. Simple list of write steps</span><br><span style="font-size: 16px; font-family: Arial; background-color: transparent; font-style: italic; vertical-align: baseline; white-space: pre-wrap;"></span><br><span style="font-size: 16px; font-family: Arial; background-color: transparent; vertical-align: baseline; white-space: pre-wrap;">That is, we write to the WAL for disaster recovery purposes and then update an in-memory copy (MemStore) of the data.</span><br><span style="font-size: 16px; font-family: Arial; background-color: transparent; vertical-align: baseline; white-space: pre-wrap;"></span><br><span style="font-size: 16px; font-family: Arial; background-color: transparent; vertical-align: baseline; white-space: pre-wrap;">Now, assume we have no concurrency control over the writes and consider the following order of events:</span></b></p>
<p><b id="internal-source-marker_0.08475310145877302" style="font-family: Times; font-size: medium; font-weight: normal;"><span style="font-size: 16px; font-family: Arial; background-color: transparent; vertical-align: baseline; white-space: pre-wrap;"></span><br><span style="font-size: 16px; font-family: Arial; background-color: transparent; vertical-align: baseline; white-space: pre-wrap;"></span><img src="https://blogs.apache.org/hbase/mediaresource/7effbc3f-0c1c-4135-9dc3-f310e9c8b652" width="440" height="183"><span style="font-size: 16px; font-family: Arial; background-color: transparent; vertical-align: baseline; white-space: pre-wrap;"></span><br><span style="font-size: 16px; font-family: Arial; background-color: transparent; font-style: italic; vertical-align: baseline; white-space: pre-wrap;">Image 2. &nbsp;One possible order of events for two writes</span><br><span style="font-size: 16px; font-family: Arial; background-color: transparent; vertical-align: baseline; white-space: pre-wrap;"></span><br><span style="font-size: 16px; font-family: Arial; background-color: transparent; vertical-align: baseline; white-space: pre-wrap;">At the end, we are left with the following state:</span></b></p>
<p><b id="internal-source-marker_0.08475310145877302" style="font-family: Times; font-size: medium; font-weight: normal;"> </b></p>
<p><b id="internal-source-marker_0.08475310145877302" style="font-family: Times; font-size: medium; font-weight: normal;"><span style="font-size: 16px; font-family: Arial; background-color: transparent; vertical-align: baseline; white-space: pre-wrap;"></span><img src="https://blogs.apache.org/hbase/mediaresource/1194e8c1-7a84-4da1-9953-1a6d74d07a4f" width="370" height="47"><span style="font-size: 16px; font-family: Arial; background-color: transparent; vertical-align: baseline; white-space: pre-wrap;"></span><br><span style="font-size: 16px; font-family: Arial; background-color: transparent; font-style: italic; vertical-align: baseline; white-space: pre-wrap;">Image 3. &nbsp;Inconsistent result in absence of write-write synchronization</span><br><span style="font-size: 16px; font-family: Arial; background-color: transparent; vertical-align: baseline; white-space: pre-wrap;"></span><br><span style="font-size: 16px; font-family: Arial; background-color: transparent; vertical-align: baseline; white-space: pre-wrap;">which is a role I&rsquo;ve never held. &nbsp;In ACID terms, we have not provided Isolation for the writes, as the two writes became intermixed.</span><br><span style="font-size: 16px; font-family: Arial; background-color: transparent; vertical-align: baseline; white-space: pre-wrap;"></span><br><span style="font-size: 16px; font-family: Arial; background-color: transparent; vertical-align: baseline; white-space: pre-wrap;">We clearly need some concurrency control. &nbsp;The simplest solution is to provide exclusive locks per row in order to provide isolation for writes that update the same row. &nbsp;So, our new list of steps for writes is as follows (new steps are in </span><span style="font-size: 16px; font-family: Arial; color: #0000ff; background-color: transparent; vertical-align: baseline; white-space: pre-wrap;">blue</span><span style="font-size: 16px; font-family: Arial; background-color: transparent; vertical-align: baseline; white-space: pre-wrap;">).</span><br><span style="font-size: 16px; font-family: Arial; background-color: transparent; vertical-align: baseline; white-space: pre-wrap;"></span><br><span style="font-size: 16px; font-family: Arial; color: #0000ff; background-color: transparent; vertical-align: baseline; white-space: pre-wrap;">(0) Obtain Row Lock</span><br><span style="font-size: 16px; font-family: Arial; background-color: transparent; vertical-align: baseline; white-space: pre-wrap;">(1) Write to Write-Ahead-Log (WAL)</span><br><span style="font-size: 16px; font-family: Arial; background-color: transparent; vertical-align: baseline; white-space: pre-wrap;">(2) Update MemStore: write each cell to the memstore</span><br><span style="font-size: 16px; font-family: Arial; color: #0000ff; background-color: transparent; vertical-align: baseline; white-space: pre-wrap;">(3) Release Row Lock</span><br><span style="font-size: 16px; font-family: Arial; background-color: transparent; font-style: italic; vertical-align: baseline; white-space: pre-wrap;">List 2: List of write-steps with write-write synchronization</span><br></b></p>
<p><b id="internal-source-marker_0.08475310145877302" style="font-family: Times; font-size: medium; font-weight: normal;"> </p>
<h2><span style="font-size: 16px; font-family: Arial; background-color: transparent; vertical-align: baseline; white-space: pre-wrap;">Read-Write Synchronization</span></h2>
<p><span style="font-size: 16px; font-family: Arial; background-color: transparent; vertical-align: baseline; white-space: pre-wrap;">So far, we&rsquo;ve added row locks to writes in order to guarantee ACID semantics. &nbsp;Do we need to add any concurrency control for reads? &nbsp;Let&rsquo;s consider another order of events for our example above (Note that this order follows the rules in </span><span style="font-size: 16px; font-family: Arial; background-color: transparent; font-style: italic; vertical-align: baseline; white-space: pre-wrap;">List 2</span><span style="font-size: 16px; font-family: Arial; background-color: transparent; vertical-align: baseline; white-space: pre-wrap;">):</span><img src="https://blogs.apache.org/hbase/mediaresource/30530bc9-0305-47a1-a5c2-86281119799c" width="701" height="266"><span style="font-size: 16px; font-family: Arial; background-color: transparent; vertical-align: baseline; white-space: pre-wrap;"></span><br><span style="font-size: 16px; font-family: Arial; background-color: transparent; font-style: italic; vertical-align: baseline; white-space: pre-wrap;">Image 4. &nbsp;One possible order of operations for two writes and a read</span><br><span style="font-size: 16px; font-family: Arial; background-color: transparent; vertical-align: baseline; white-space: pre-wrap;"></span><br><span style="font-size: 16px; font-family: Arial; background-color: transparent; vertical-align: baseline; white-space: pre-wrap;">Assume no concurrency control for reads and that we request a read concurrently with the two writes. &nbsp;Assume the read is executed directly before &ldquo;Waiter&rdquo; is written to the MemStore; this read action is represented by a red line above. &nbsp;In that case, we will again read the inconsistent row:</span></p>
<p><span style="font-size: 16px; font-family: Arial; background-color: transparent; vertical-align: baseline; white-space: pre-wrap;"></span><img src="https://blogs.apache.org/hbase/mediaresource/1194e8c1-7a84-4da1-9953-1a6d74d07a4f" width="370" height="47"><span style="font-size: 16px; font-family: Arial; background-color: transparent; vertical-align: baseline; white-space: pre-wrap;"></span><br><span style="font-size: 16px; font-family: Arial; background-color: transparent; font-style: italic; vertical-align: baseline; white-space: pre-wrap;">Image 5. &nbsp;Inconsistent result in absence of read-write synchronization</span><br><span style="font-size: 16px; font-family: Arial; background-color: transparent; vertical-align: baseline; white-space: pre-wrap;"></span><br><span style="font-size: 16px; font-family: Arial; background-color: transparent; vertical-align: baseline; white-space: pre-wrap;">Therefore, we need some concurrency control to deal with read-write synchronization. &nbsp;The simplest solution would be to have the reads obtain and release the row locks in the same manner as the writes. &nbsp;This would resolve the ACID violation, but the downside is that our reads and writes would both contend for the row locks, slowing each other down.</span><br><span style="font-size: 16px; font-family: Arial; background-color: transparent; vertical-align: baseline; white-space: pre-wrap;"></span><br><span style="font-size: 16px; font-family: Arial; background-color: transparent; vertical-align: baseline; white-space: pre-wrap;">Instead, HBase uses a form of </span><a href="http://en.wikipedia.org/wiki/Multiversion_concurrency_control"><span style="font-size: 16px; font-family: Arial; color: #1155cc; background-color: transparent; text-decoration: underline; vertical-align: baseline; white-space: pre-wrap;">Multiversion Concurrency Control</span></a><span style="font-size: 16px; font-family: Arial; background-color: transparent; vertical-align: baseline; white-space: pre-wrap;"> (MVCC) to avoid requiring the reads to obtain row locks. &nbsp;Multiversion Concurrency Control works in HBase as follows:</span><br><span style="font-size: 16px; font-family: Arial; background-color: transparent; vertical-align: baseline; white-space: pre-wrap;"></span><br><span style="font-size: 16px; font-family: Arial; background-color: transparent; vertical-align: baseline; white-space: pre-wrap;">For writes:</span><br><span style="font-size: 16px; font-family: Arial; background-color: transparent; vertical-align: baseline; white-space: pre-wrap;">(w1) After acquiring the RowLock, each write operation is immediately assigned a write number</span><br><span style="font-size: 16px; font-family: Arial; background-color: transparent; vertical-align: baseline; white-space: pre-wrap;">(w2) Each data cell in the write stores its write number.</span><br><span style="font-size: 16px; font-family: Arial; background-color: transparent; vertical-align: baseline; white-space: pre-wrap;">(w3) A write operation completes by declaring it is finished with the write number.</span><br><span style="font-size: 16px; font-family: Arial; background-color: transparent; vertical-align: baseline; white-space: pre-wrap;"></span><br><span style="font-size: 16px; font-family: Arial; background-color: transparent; vertical-align: baseline; white-space: pre-wrap;">For reads:</span><br><span style="font-size: 16px; font-family: Arial; background-color: transparent; vertical-align: baseline; white-space: pre-wrap;">(r1) &nbsp;Each read operation is first assigned a read timestamp, called a read point.</span><br><span style="font-size: 16px; font-family: Arial; background-color: transparent; vertical-align: baseline; white-space: pre-wrap;">(r2) &nbsp;The read point is assigned to be the highest integer such that all writes with write number <= x have been completed.</span><br><span style="font-size: 16px; font-family: Arial; background-color: transparent; vertical-align: baseline; white-space: pre-wrap;">(r3) &nbsp;A read r for a certain (row, column) combination returns the data cell with the matching (row, column) whose write number is the largest value that is less than or equal to the read point of r.</span><br><span style="font-size: 16px; font-family: Arial; background-color: transparent; font-style: italic; vertical-align: baseline; white-space: pre-wrap;">List 3. Multiversion Concurrency Control steps</span><br><span style="font-size: 16px; font-family: Arial; background-color: transparent; font-style: italic; vertical-align: baseline; white-space: pre-wrap;"></span><br><span style="font-size: 16px; font-family: Arial; background-color: transparent; vertical-align: baseline; white-space: pre-wrap;">Let&rsquo;s look at the operations in Image 4 again, this time using MultiVersion Concurrency Control:</span></p>
<p><img src="https://blogs.apache.org/hbase/mediaresource/0b9831a0-54aa-4c41-b560-77ba33daceb5" width="721" height="278"><span style="font-size: 16px; font-family: Arial; background-color: transparent; vertical-align: baseline; white-space: pre-wrap;"></span><br><span style="font-size: 16px; font-family: Arial; background-color: transparent; font-style: italic; vertical-align: baseline; white-space: pre-wrap;">Image 6. &nbsp;Write steps with Multiversion Concurrency Control</span><br><span style="font-size: 16px; font-family: Arial; background-color: transparent; vertical-align: baseline; white-space: pre-wrap;"></span><br><span style="font-size: 16px; font-family: Arial; background-color: transparent; vertical-align: baseline; white-space: pre-wrap;">Notice the new steps introduced for Multiversion Concurrency Control. &nbsp;Each write is assigned a write number (step w1), each data cell is written to the memstore with its write number (step w2, e.g. &ldquo;Cloudera [wn=1]&rdquo;) and each write completes by finishing its write number (step w3).</span><br><span style="font-size: 16px; font-family: Arial; background-color: transparent; vertical-align: baseline; white-space: pre-wrap;"></span><br><span style="font-size: 16px; font-family: Arial; background-color: transparent; vertical-align: baseline; white-space: pre-wrap;">Now, let&rsquo;s consider the read in Image 4, i.e. a read that begins after step &ldquo;Restaurant [wn=2]&rdquo; but before the step &ldquo;Waiter [wn=2]&rdquo;. &nbsp;From rule r1 and r2, its read point will be assigned to 1. &nbsp;From r3, it will read the values with write number of 1, leaving us with:</span><br><span style="font-size: 16px; font-family: Arial; background-color: transparent; vertical-align: baseline; white-space: pre-wrap;"></span><img src="https://blogs.apache.org/hbase/mediaresource/12b2c8a4-551b-4aa5-8629-874e220a91bd" width="367" height="49"><span style="font-size: 16px; font-family: Arial; background-color: transparent; vertical-align: baseline; white-space: pre-wrap;"></span><br><span style="font-size: 16px; font-family: Arial; background-color: transparent; font-style: italic; vertical-align: baseline; white-space: pre-wrap;">Image 7. &nbsp;Consistent answer with Multiversion Concurrency Control</span><br><span style="font-size: 16px; font-family: Arial; background-color: transparent; vertical-align: baseline; white-space: pre-wrap;"></span><br><span style="font-size: 16px; font-family: Arial; background-color: transparent; vertical-align: baseline; white-space: pre-wrap;">A consistent response without requiring locking the row for the reads!</span><br><span style="font-size: 16px; font-family: Arial; background-color: transparent; vertical-align: baseline; white-space: pre-wrap;"></span><br><span style="font-size: 16px; font-family: Arial; background-color: transparent; vertical-align: baseline; white-space: pre-wrap;">Let&rsquo;s put this all together by listing the steps for a write with Multiversion Concurrency Control: (new steps required for read-write synchronization are in red):</span><br><span style="font-size: 16px; font-family: Arial; background-color: transparent; vertical-align: baseline; white-space: pre-wrap;">(0) Obtain Row Lock</span><br><span style="font-size: 16px; font-family: Arial; color: #ff0000; background-color: transparent; vertical-align: baseline; white-space: pre-wrap;">(0a) Acquire New Write Number</span><br><span style="font-size: 16px; font-family: Arial; background-color: transparent; vertical-align: baseline; white-space: pre-wrap;">(1) Write to Write-Ahead-Log (WAL)</span><br><span style="font-size: 16px; font-family: Arial; background-color: transparent; vertical-align: baseline; white-space: pre-wrap;">(2) Update MemStore: write each cell to the memstore</span><br><span style="font-size: 16px; font-family: Arial; color: #ff0000; background-color: transparent; vertical-align: baseline; white-space: pre-wrap;">(2a) Finish Write Number</span><br><span style="font-size: 16px; font-family: Arial; background-color: transparent; vertical-align: baseline; white-space: pre-wrap;">(3) Release Row Lock</span><br></p>
<h2><span style="font-size: 16px; font-family: Arial; background-color: transparent; vertical-align: baseline; white-space: pre-wrap;">Conclusion</span></h2>
<p><span style="font-size: 16px; font-family: Arial; background-color: transparent; vertical-align: baseline; white-space: pre-wrap;">In this blog we first defined HBase&rsquo;s row-level ACID guarantees. &nbsp;We then demonstrated the need for concurrency control by studying concurrent writes and introduced a row-level locking solution. &nbsp;Finally, we investigated read-write concurrency control and presented an efficient mechanism called Multiversion Concurrency Control (MVCC).</span><br><span style="font-size: 16px; font-family: Arial; background-color: transparent; vertical-align: baseline; white-space: pre-wrap;"></span><br><span style="font-size: 16px; font-family: Arial; background-color: transparent; vertical-align: baseline; white-space: pre-wrap;">This blog post is accurate as of HBase 0.92. &nbsp;HBase 0.94 has various optimizations, e.g. </span><a href="https://issues.apache.org/jira/browse/HBASE-5541"><span style="font-size: 16px; font-family: Arial; color: #1155cc; background-color: transparent; text-decoration: underline; vertical-align: baseline; white-space: pre-wrap;">HBASE-5541</span></a><span style="font-size: 16px; font-family: Arial; background-color: transparent; vertical-align: baseline; white-space: pre-wrap;"> that will be described in a future blog post.</span></b></p>
<p>&nbsp;</p>
